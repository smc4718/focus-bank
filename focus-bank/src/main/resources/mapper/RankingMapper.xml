<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pyj.focusbank.dao.RankingMapper">

    <!-- ==========================================================
         주간 랭킹 조회
         - 이번 주 월요일(monday)부터 오늘(today)까지 집계
         - daily_aggregate 합산 → 사용자별 총합
         - anonymous_user LEFT JOIN (닉네임 없어도 anon 표시 가능)
         - Service에서 displayName 조합
         ========================================================== -->
    <select id="selectWeeklyRanking" resultType="map">
        SELECT
               da.anon_id,                              -- 사용자 ID
               u.nickname,                              -- 닉네임
               u.nickname_tag,                          -- 닉네임 태그
               SUM(da.total_seconds) AS total_seconds   -- 집중 시간 합계
          FROM daily_aggregate da
                 LEFT JOIN anonymous_user u
                           ON da.anon_id = u.anon_id
         WHERE da.target_date BETWEEN #{monday} AND #{today}
         GROUP BY da.anon_id, u.nickname, u.nickname_tag
         ORDER BY total_seconds DESC
               LIMIT #{limit}
    </select>

    <!-- ==========================================================
         전체 누적 랭킹 조회
         - daily_aggregate 전체 기간 합산
         - TOP N 반환
         - Service에서 displayName 조합
         ========================================================== -->
    <select id="selectOverallRanking" resultType="map">
        SELECT
               da.anon_id,
               u.nickname,
               u.nickname_tag,
               SUM(da.total_seconds) AS total_seconds
          FROM daily_aggregate da
                 LEFT JOIN anonymous_user u
                           ON da.anon_id = u.anon_id
         GROUP BY da.anon_id, u.nickname, u.nickname_tag
         ORDER BY total_seconds DESC
               LIMIT #{limit}
    </select>

</mapper>
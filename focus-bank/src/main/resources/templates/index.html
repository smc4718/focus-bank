<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Focus Bank - ë””ì§€í„¸ ì§‘ì¤‘ë ¥ ì€í–‰</title>
    <style>
        :root { --bg:#0f172a; --card:#111827; --muted:#9ca3af; --txt:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --brand:#38bdf8; }
        *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,AppleSDGothicNeo,'Noto Sans KR',Segoe UI,Roboto,Arial;background:linear-gradient(120deg,#0b1220,#10192b)}
        .wrap{max-width:960px;margin:0 auto;padding:28px}
        .app-title{display:flex;align-items:center;gap:12px;color:#fff}
        .logo{font-size:28px}
        .subtitle{color:var(--muted);margin-top:4px}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px}
        .card{background:rgba(17,24,39,.8);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:18px;color:var(--txt);box-shadow:0 10px 30px rgba(0,0,0,.25)}
        .section-title{margin:0 0 10px 0;color:#fff;font-weight:700;font-size:18px}
        .row{display:flex;justify-content:space-between;align-items:center;margin:10px 0}
        .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:8px 12px;background:rgba(255,255,255,.06);color:#fff}
        .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
        .btns{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
        button{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:700;color:#0b1020;transition:.2s}
        .btn-deposit{background:var(--accent)}
        .btn-settle{background:var(--danger)}
        .btn-deposit:disabled,.btn-settle:disabled{opacity:.5;cursor:not-allowed}
        .balance{font-size:28px;font-weight:800;color:#fff}
        .muted{color:var(--muted);font-size:13px}
        .toast{position:fixed;right:20px;bottom:20px;background:#111827;color:#fff;border:1px solid rgba(255,255,255,.12);padding:12px 16px;border-radius:12px;opacity:0;transform:translateY(10px);transition:.2s}
        .toast.show{opacity:1;transform:none}
        .hero{margin-top:18px;display:flex;gap:10px;align-items:center;color:#cbd5e1}
        .hero b{color:#fff}
        .timer{font-variant-numeric:tabular-nums}
        .footer{margin-top:18px;color:#6b7280;font-size:12px}
        @media (max-width:800px){.grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="wrap">
    <div class="app-title">
        <div class="logo">ğŸ¦</div>
        <div>
            <h1 style="margin:0;color:#fff;">Focus Bank</h1>
            <div class="subtitle">ì§‘ì¤‘ ì‹œê°„ì„ ëˆì²˜ëŸ¼ <b>ì…ê¸ˆ/ì •ì‚°</b>í•˜ì„¸ìš”</div>
        </div>
    </div>

    <!-- ì‚¬ìš©ì/ì„¸ì…˜ ìƒíƒœ -->
    <div class="grid">
        <div class="card">
            <h2 class="section-title">ë‚´ ì •ë³´</h2>
            <div class="row">
                <div>ì‹ë³„ì</div>
                <div id="anonDisplay" class="pill mono">anon-????</div>
            </div>
            <div class="row">
                <div>í˜„ì¬ ìƒíƒœ</div>
                <div id="statusPill" class="pill">ëŒ€ê¸° ì¤‘</div>
            </div>
            <div class="row">
                <div>ì§„í–‰ íƒ€ì´ë¨¸</div>
                <div id="liveTimer" class="mono timer">00:00:00</div>
            </div>
            <div class="btns">
                <button id="btnDeposit" class="btn-deposit">ì…ê¸ˆí•˜ê¸°</button>
                <button id="btnSettle" class="btn-settle" disabled>ì •ì‚°í•˜ê¸°</button>

            </div>
            <div class="hero">
                ğŸ’¡ <span>ì…ê¸ˆì€ ì§‘ì¤‘ ì‹œì‘, ì •ì‚°ì€ ì¢…ë£Œë¥¼ ì˜ë¯¸í•´ìš”.</span>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">ì¼ì¼ ì…ê¸ˆëœ ì§‘ì¤‘</h2>
            <div class="balance" id="todayTotal">--:--:--</div>
            <div class="muted">ì˜¤ëŠ˜ ëˆ„ì  ì§‘ì¤‘ ì‹œê°„</div>
        </div>
    </div>

    <div class="footer">Â© Focus Bank Â· ë‹¨ì¼ í˜ì´ì§€ ëŒ€ì‹œë³´ë“œ (Thymeleaf + JS)</div>
</div>

<div id="toast" class="toast"></div>

<script>
    // ====== ê°„ë‹¨ ULID ìƒì„± (í´ë¼ì´ì–¸íŠ¸ ìµœì´ˆ ì§„ì… ì‹œ) ======
    // ì„œë²„ì—ì„œ ìƒì„±/ì „ë‹¬í•´ë„ ë¨. ì´ ì½”ë“œëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´ ê°€ë²¼ìš´ ë²„ì „.
    (function ensureAnon() {
        let anonId = localStorage.getItem('anonId');
        if (!anonId) {
            anonId = generateULID();
            localStorage.setItem('anonId', anonId);
            // âš ï¸ ì„œë²„ëŠ” ì´ anonIdê°€ anonymous_user í…Œì´ë¸”ì— ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤.
            // ì´ˆê¸°ì—” ìˆ˜ë™ ì‹œë“œ, ì´í›„ì—” ì„œë²„ì—ì„œ 'ì—†ìœ¼ë©´ ìƒì„±' ë¡œì§/ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ ê¶Œì¥.
        }
    })();

    // ====== ìƒíƒœ/DOM ======
    const anonId = localStorage.getItem('anonId');
    const anonDisplay = document.getElementById('anonDisplay');
    const statusPill  = document.getElementById('statusPill');
    const liveTimerEl = document.getElementById('liveTimer');
    const btnDeposit  = document.getElementById('btnDeposit');
    const btnSettle   = document.getElementById('btnSettle');
    const toastEl     = document.getElementById('toast');
    const todayTotal  = document.getElementById('todayTotal');

    let currentSessionId = null;
    let tickTimer = null;
    let startedAtMs = null;

    // í‘œì‹œìš© ë§ˆìŠ¤í‚¹
    anonDisplay.textContent = maskAnon(anonId);

    // ë²„íŠ¼ ì´ë²¤íŠ¸
    btnDeposit.addEventListener('click', onDeposit);
    btnSettle.addEventListener('click', onSettle);

    // ì¼ì¼ ìš”ì•½
    fetchTodaySummary();

    // ====== ì•¡ì…˜: ì…ê¸ˆ(ì§‘ì¤‘ ì‹œì‘) ======
    async function onDeposit() {
        try {
            btnDeposit.disabled = true;
            const res = await fetch('/api/sessions/deposit', {
                method: 'POST',
                headers: { 'X-ANON-ID': anonId }
            });

            if (res.status === 409) {
                // ë°±ì—”ë“œì—ì„œ Conflict ì‘ë‹µ (ì´ë¯¸ ì—´ë¦° ì„¸ì…˜)
                showToast('ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ì„¸ì…˜ì´ ìˆìŠµë‹ˆë‹¤.', true);
                btnDeposit.disabled = false;
                return;
            }

            if (!res.ok) {
                throw new Error(await res.text());
            }

            const data = await res.json(); // FocusSessionDto
            currentSessionId = data.sessionId;
            startedAtMs = Date.parse(data.startedAt ?? data.createdAt);
            setStatusRunning();
            startTick();
            showToast('ì…ê¸ˆì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨');
        } catch (e) {
            showToast('ì…ê¸ˆ ì‹¤íŒ¨: ' + (e.message || e), true);
            btnDeposit.disabled = false;
        }
    }

    // ====== ì•¡ì…˜: ì •ì‚°(ì§‘ì¤‘ ì¢…ë£Œ) ======
    async function onSettle() {
        if (!currentSessionId) {
            showToast('ì§„í–‰ ì¤‘ì¸ ì…ê¸ˆ(ì§‘ì¤‘)ì´ ì—†ìŠµë‹ˆë‹¤.', true);
            return;
        }
        try {
            btnSettle.disabled = true;
            const res = await fetch(`/api/sessions/settle?sessionId=${currentSessionId}`, { method: 'POST' });

            if (res.status === 409) {
                // ë°±ì—”ë“œì—ì„œ Conflict ì‘ë‹µ (ì´ë¯¸ ì¢…ë£Œëœ ì„¸ì…˜)
                showToast('ì´ë¯¸ ì¢…ë£Œëœ ì„¸ì…˜ì…ë‹ˆë‹¤.', true);
                btnSettle.disabled = false;
                return;
            }

            if (!res.ok) {
                throw new Error(await res.text());
            }

            const data = await res.json();
            stopTick();
            setStatusIdle();
            // ì§‘ì¤‘ ì™„ë£Œ í›„ ì˜¤ëŠ˜ ìš”ì•½ ìë™ ê°±ì‹ 
            await fetchTodaySummary();
            showToast(`ì •ì‚° ì™„ë£Œ! ì´ë²ˆ ì…ê¸ˆ: ${fmtSec(data.durationSec || 0)} â±ï¸`);
        } catch (e) {
            showToast('ì •ì‚° ì‹¤íŒ¨: ' + (e.message || e), true);
            btnSettle.disabled = false;
        }
    }

    // ====== ìƒíƒœ ì „í™˜ / íƒ€ì´ë¨¸ ======
    function setStatusRunning() {
        statusPill.textContent = 'ì…ê¸ˆ ì¤‘';
        statusPill.style.background = 'rgba(34,197,94,.15)';
        statusPill.style.borderColor = 'rgba(34,197,94,.35)';
        btnSettle.disabled = false;
        btnDeposit.disabled = true;
    }

    function setStatusIdle() {
        statusPill.textContent = 'ëŒ€ê¸° ì¤‘';
        statusPill.style.background = 'rgba(255,255,255,.06)';
        statusPill.style.borderColor = 'rgba(255,255,255,.12)';
        btnSettle.disabled = true;
        btnDeposit.disabled = false;
        liveTimerEl.textContent = '00:00:00';
        currentSessionId = null;
        startedAtMs = null;
    }

    function startTick() {
        if (!startedAtMs) startedAtMs = Date.now();
        liveTimerEl.textContent = fmtSec(Math.floor((Date.now() - startedAtMs)/1000));
        tickTimer = setInterval(() => {
            const sec = Math.floor((Date.now() - startedAtMs)/1000);
            liveTimerEl.textContent = fmtSec(sec);
        }, 1000);
    }
    function stopTick() { if (tickTimer) clearInterval(tickTimer); }

    // ====== ìœ í‹¸ ======
    function showToast(msg, error=false){
        toastEl.textContent = msg;
        toastEl.style.borderColor = error ? 'rgba(239,68,68,.5)' : 'rgba(56,189,248,.5)';
        toastEl.classList.add('show');
        setTimeout(()=>toastEl.classList.remove('show'), 2200);
    }

    function maskAnon(id){
        if(!id) return 'anon-****';
        const tail = id.slice(-4).toUpperCase();
        return 'anon-' + tail;
        // (ê³ ë ¤ì‚¬í•­ : ë‹‰ë„¤ì„ì´ ìˆë‹¤ë©´ ì„œë²„ ì‘ë‹µì—ì„œ displayName ë‚´ë ¤ í™œìš©í•´ë„ ì¢‹ìŒ)
    }

    function fmtSec(s){
        const h = Math.floor(s/3600).toString().padStart(2,'0');
        const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
        const sec = Math.floor(s%60).toString().padStart(2,'0');
        return `${h}:${m}:${sec}`;
    }

    // ê°„ë‹¨í•œ ULID ìƒì„±ê¸° (Crockford Base32)
    function generateULID(){
        const ENCODING = "0123456789ABCDEFGHJKMNPQRSTVWXYZ";
        function encodeTime(t){
            let out = "";
            for(let i=9;i>=0;i--){ out = ENCODING[(t >>> (i*5)) & 31] + out; }
            return out;
        }
        function rand(n){
            const bytes = new Uint8Array(n);
            (crypto.getRandomValues || window.msCrypto.getRandomValues).call(crypto, bytes);
            return Array.from(bytes);
        }
        const time = Date.now();
        // time(48ë¹„íŠ¸) â†’ 10 chars, random(80ë¹„íŠ¸) â†’ 16 chars
        // JS ë¹„íŠ¸ ì—°ì‚° í•œê³„ë¡œ ì‰¬ìš´ ë°©ì‹ìœ¼ë¡œ ì¸ì½”ë”©
        let t = time;
        const timeChars = [];
        for(let i=0;i<10;i++){
            timeChars.push(ENCODING[t % 32]); t = Math.floor(t/32);
        }
        const randomBytes = rand(16);
        const randChars = [];
        let carry = 0, bits = 0, val = 0;
        for (let i=0;i<randomBytes.length;i++){
            val = (val << 8) | randomBytes[i];
            bits += 8;
            while(bits >= 5){
                bits -= 5;
                randChars.push(ENCODING[(val >>> bits) & 31]);
            }
        }
        while(randChars.length < 16) randChars.push('0');
        return timeChars.reverse().join('') + randChars.slice(0,16).join('');
    }

    // ì¼ì¼ ì§‘ì¤‘ ìš”ì•½ API í˜¸ì¶œ
    async function fetchTodaySummary(){
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const dateStr = `${yyyy}-${mm}-${dd}`;
        try{
            const res = await fetch(`/api/reports/summary?date=${dateStr}`, { headers: {'X-ANON-ID': anonId} });
            if(res.ok){
                const json = await res.json(); // { targetDate, totalSec }
                todayTotal.textContent = fmtSec(json.totalSec ?? 0);
            }else{
                todayTotal.textContent = '--:--:--';
            }
        }catch(_){
            todayTotal.textContent = '--:--:--';
        }
    }
</script>
</body>
</html>
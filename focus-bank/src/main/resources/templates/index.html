<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Focus Bank - ë””ì§€í„¸ ì§‘ì¤‘ë ¥ ì€í–‰</title>
    <style>
        :root { --bg:#0f172a; --card:#111827; --muted:#9ca3af; --txt:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --brand:#38bdf8; }
        *{box-sizing:border-box}
        body{margin:0;font-family:ui-sans-serif,system-ui,AppleSDGothicNeo,'Noto Sans KR',Segoe UI,Roboto,Arial;background:linear-gradient(120deg,#0b1220,#10192b)}
        .wrap{max-width:960px;margin:0 auto;padding:28px}
        .app-title{display:flex;align-items:center;gap:12px;color:#fff}
        .logo{font-size:28px}
        .subtitle{color:var(--muted);margin-top:4px}

        /* ê³µí†µ ì¹´ë“œ/ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px}
        .card{background:rgba(17,24,39,.8);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:18px;color:var(--txt);box-shadow:0 10px 30px rgba(0,0,0,.25)}
        .section-title{margin:0 0 10px 0;color:#fff;font-weight:700;font-size:18px}
        .row{display:flex;justify-content:space-between;align-items:center;margin:10px 0}
        .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:8px 12px;background:rgba(255,255,255,.06);color:#fff}
        .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
        .btns{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
        button{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:700;color:#0b1020;transition:.2s}
        .btn-deposit{background:var(--accent)}
        .btn-settle{background:var(--danger)}
        .btn-deposit:disabled,.btn-settle:disabled{opacity:.5;cursor:not-allowed}
        .balance{font-size:28px;font-weight:800;color:#fff}
        .muted{color:var(--muted);font-size:13px}
        .toast{position:fixed;right:20px;bottom:20px;background:#111827;color:#fff;border:1px solid rgba(255,255,255,.12);padding:12px 16px;border-radius:12px;opacity:0;transform:translateY(10px);transition:.2s}
        .toast.show{opacity:1;transform:none}
        .hero{margin-top:18px;display:flex;gap:10px;align-items:center;color:#cbd5e1}
        .hero b{color:#fff}
        .timer{font-variant-numeric:tabular-nums}
        .footer{margin-top:18px;color:#6b7280;font-size:12px}
        @media (max-width:800px){.grid{grid-template-columns:1fr}}

        /* === (ì¶”ê°€) ìƒë‹¨ SPA ë„¤ë¹„ê²Œì´ì…˜ íƒ­ === */
        .tabs{display:flex;gap:8px;margin-top:14px}
        .tab{border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:8px 12px;background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
        .tab.active{background:#fff;color:#0b1220}

        /* === (ì¶”ê°€) ëª©í‘œ ì§„í–‰ë¥  ë°” === */
        .progress{height:12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);overflow:hidden}
        .progress .bar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#38bdf8)}
    </style>
</head>
<body>
<div class="wrap">
    <div class="app-title">
        <div class="logo">ğŸ¦</div>
        <div>
            <h1 style="margin:0;color:#fff;">Focus Bank</h1>
            <div class="subtitle">ì§‘ì¤‘ ì‹œê°„ì„ ëˆì²˜ëŸ¼ <b>ì…ê¸ˆ/ì •ì‚°</b>í•˜ì„¸ìš”</div>
        </div>
    </div>

    <!-- === (ì¶”ê°€) SPA ë„¤ë¹„ê²Œì´ì…˜: í•´ì‹œ ë¼ìš°íŒ…ìœ¼ë¡œ í™”ë©´ ì „í™˜ === -->
    <div class="tabs">
        <div id="tab-dashboard" class="tab">ëŒ€ì‹œë³´ë“œ</div>
        <div id="tab-reports" class="tab">ë¦¬í¬íŠ¸</div>
    </div>

    <!-- ========== [ë·°1] ëŒ€ì‹œë³´ë“œ (ê¸°ì¡´) ========== -->
    <section id="view-dashboard">
        <!-- ìƒë‹¨: ì‚¬ìš©ì/ì„¸ì…˜ ìƒíƒœ -->
        <div class="grid">
            <div class="card">
                <h2 class="section-title">ë‚´ ì •ë³´</h2>
                <div class="row">
                    <div>ì‹ë³„ì</div>
                    <div id="anonDisplay" class="pill mono">anon-????</div>
                </div>
                <div class="row">
                    <div>í˜„ì¬ ìƒíƒœ</div>
                    <div id="statusPill" class="pill">ëŒ€ê¸° ì¤‘</div>
                </div>
                <div class="row">
                    <div>ì§„í–‰ íƒ€ì´ë¨¸</div>
                    <div id="liveTimer" class="mono timer">00:00:00</div>
                </div>
                <div class="btns">
                    <button id="btnDeposit" class="btn-deposit">ì…ê¸ˆí•˜ê¸°</button>
                    <button id="btnSettle" class="btn-settle" disabled>ì •ì‚°í•˜ê¸°</button>
                    <!-- (ì¶”ê°€) ë¦¬í¬íŠ¸ë¡œ ì´ë™ -->
                    <button class="pill" id="btnGoReports">ë¦¬í¬íŠ¸ ë³´ê¸°</button>
                </div>
                <div class="hero">
                    ğŸ’¡ <span>ì…ê¸ˆì€ ì§‘ì¤‘ ì‹œì‘, ì •ì‚°ì€ ì¢…ë£Œë¥¼ ì˜ë¯¸í•´ìš”.</span>
                </div>
            </div>

            <!-- ì˜¤ëŠ˜ ìš”ì•½ -->
            <div class="card">
                <h2 class="section-title">ì¼ì¼ ì…ê¸ˆëœ ì§‘ì¤‘</h2>
                <div class="balance" id="todayTotal">--:--:--</div>
                <div class="muted">ì˜¤ëŠ˜ ëˆ„ì  ì§‘ì¤‘ ì‹œê°„</div>
            </div>
        </div>

        <!-- === (ì¶”ê°€) Overview ë¯¸ë‹ˆ ì¹´ë“œ 3ì¢…: ì´ë²ˆ ì£¼ / ì´ë²ˆ ë‹¬ / ëª©í‘œ ì§„í–‰ë¥  === -->
        <div class="grid">
            <!-- ì´ë²ˆ ì£¼ í•©ê³„ -->
            <div class="card">
                <h2 class="section-title">ì´ë²ˆ ì£¼ í•©ê³„</h2>
                <div class="balance" id="thisWeekTotal">--:--:--</div>
                <div class="muted">ì›”ìš”ì¼~ì˜¤ëŠ˜ ê¸°ì¤€(ISO ì£¼)</div>
            </div>
            <!-- ì´ë²ˆ ë‹¬ í•©ê³„ -->
            <div class="card">
                <h2 class="section-title">ì´ë²ˆ ë‹¬ í•©ê³„</h2>
                <div class="balance" id="thisMonthTotal">--:--:--</div>
                <div class="muted">1ì¼~ì˜¤ëŠ˜ ê¸°ì¤€</div>
            </div>
            <!-- ëª©í‘œ ì§„í–‰ë¥  -->
            <div class="card" style="grid-column: 1 / -1">
                <h2 class="section-title">ì˜¤ëŠ˜ ëª©í‘œ ì§„í–‰ë¥ </h2>
                <div class="row">
                    <div class="muted">ë‹¬ì„±ë¥ </div>
                    <div id="goalPct" class="pill">ë¯¸ì„¤ì •</div>
                </div>
                <div class="progress"><div id="goalBar" class="bar"></div></div>
                <div class="muted" id="goalDesc" style="margin-top:8px;">ëª©í‘œë¥¼ ì„¤ì •í•´ ë³´ì„¸ìš”.</div>
            </div>
        </div>
    </section>

    <!-- ========== [ë·°2] ë¦¬í¬íŠ¸ ========== -->
    <section id="view-reports" hidden>
        <div class="grid">
            <div class="card" style="grid-column:1 / -1">
                <h2 class="section-title">ì£¼ê°„/ì›”ê°„ ì§‘ì¤‘ ë¦¬í¬íŠ¸</h2>
                <div class="btns" style="margin-bottom:8px;">
                    <button class="pill" id="btnWeekly" data-mode="weekly">ì£¼ê°„</button>
                    <button class="pill" id="btnMonthly" data-mode="monthly">ì›”ê°„</button>
                </div>
                <div style="border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:12px;">
                    <canvas id="reportChart"></canvas>
                    <div class="muted" id="rangeLabel" style="margin-top:6px;"></div>
                </div>
                <div class="grid" style="margin-top:16px;">
                    <div class="card">
                        <div>ì´ ì§‘ì¤‘ì‹œê°„</div>
                        <div class="balance" id="kpiTotal">--:--:--</div>
                        <div class="muted">ì„ íƒëœ ê¸°ê°„ í•©ê³„</div>
                    </div>
                    <div class="card">
                        <div>ì¼ë‹¹ í‰ê· </div>
                        <div class="balance" id="kpiAvg">0ì´ˆ</div>
                        <div class="muted">í•´ë‹¹ ê¸°ê°„ ì¼í‰ê· (ì´ˆ)</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="footer">Â© Focus Bank Â· ë‹¨ì¼ í˜ì´ì§€ ëŒ€ì‹œë³´ë“œ (Thymeleaf + JS)</div>
</div>

<div id="toast" class="toast"></div>

<script>
    /* =========================
       ê³µí†µ: ìµëª… ID ë°œê¸‰/í‘œì‹œ
    ==========================*/
    (function ensureAnon() {
        let anonId = localStorage.getItem('anonId');
        if (!anonId) {
            anonId = generateULID();
            localStorage.setItem('anonId', anonId);
            // ì„œë²„ì— anonymous_user ìë™ ìƒì„± ë¡œì§ì„ ë‘ë©´ ë² ìŠ¤íŠ¸
        }
    })();
    const anonId = localStorage.getItem('anonId');

    // ê³µí†µ ì—˜ë¦¬ë¨¼íŠ¸
    const anonDisplay = document.getElementById('anonDisplay');
    const statusPill  = document.getElementById('statusPill');
    const liveTimerEl = document.getElementById('liveTimer');
    const btnDeposit  = document.getElementById('btnDeposit');
    const btnSettle   = document.getElementById('btnSettle');
    const toastEl     = document.getElementById('toast');
    const todayTotal  = document.getElementById('todayTotal');

    // ëŒ€ì‹œë³´ë“œ ìš”ì•½ ì¹´ë“œ ì—˜ë¦¬ë¨¼íŠ¸
    const thisWeekTotal  = document.getElementById('thisWeekTotal');
    const thisMonthTotal = document.getElementById('thisMonthTotal');
    const goalPct        = document.getElementById('goalPct');
    const goalBar        = document.getElementById('goalBar');
    const goalDesc       = document.getElementById('goalDesc');

    // ë¦¬í¬íŠ¸ ì—˜ë¦¬ë¨¼íŠ¸
    const tabDashboard = document.getElementById('tab-dashboard');
    const tabReports   = document.getElementById('tab-reports');
    const btnGoReports = document.getElementById('btnGoReports');
    const btnWeekly    = document.getElementById('btnWeekly');
    const btnMonthly   = document.getElementById('btnMonthly');
    const reportCanvas = document.getElementById('reportChart');
    const kpiTotal     = document.getElementById('kpiTotal');
    const kpiAvg       = document.getElementById('kpiAvg');
    const rangeLabel   = document.getElementById('rangeLabel');

    // í‘œì‹œìš© ë§ˆìŠ¤í‚¹
    anonDisplay.textContent = maskAnon(anonId);

    // ë²„íŠ¼ ì´ë²¤íŠ¸
    btnDeposit.addEventListener('click', onDeposit);
    btnSettle.addEventListener('click', onSettle);
    btnGoReports.addEventListener('click', () => navigate('#/reports'));

    // ì´ˆê¸° ìš”ì•½ ë¡œë”©
    fetchTodaySummary();
    fetchThisWeekTotal();
    fetchThisMonthTotal();
    fetchGoalProgressDaily();

    /* =========================
       SPA í•´ì‹œ ë¼ìš°í„°
    ==========================*/
    const routes = {
        '#/dashboard': () => {
            setActiveTab('dashboard');
            showView('view-dashboard');
        },
        '#/reports': async () => {
            setActiveTab('reports');
            showView('view-reports');
            if (!window.__chartLoaded) {
                await loadChartJs();
                window.__chartLoaded = true;
            }
            if (!window.__reportMode) window.__reportMode = 'weekly';
            await renderReport(window.__reportMode);
        }
    };
    function navigate(hash){ if (location.hash === hash) routes[hash]?.(); else location.hash = hash; }
    function setActiveTab(name){
        tabDashboard.classList.toggle('active', name === 'dashboard');
        tabReports.classList.toggle('active', name === 'reports');
    }
    function showView(id){
        document.getElementById('view-dashboard').hidden = id !== 'view-dashboard';
        document.getElementById('view-reports').hidden   = id !== 'view-reports';
    }
    function router(){ const hash = location.hash || '#/dashboard'; (routes[hash] || routes['#/dashboard'])(); }
    window.addEventListener('hashchange', router);
    window.addEventListener('load', router);
    tabDashboard.addEventListener('click', () => navigate('#/dashboard'));
    tabReports  .addEventListener('click', () => navigate('#/reports'));

    /* =========================
       ë¦¬í¬íŠ¸ (Chart.js ì§€ì—° ë¡œë”©)
    ==========================*/
    async function loadChartJs(){
        await import('https://cdn.jsdelivr.net/npm/chart.js');
    }
    btnWeekly.addEventListener('click', () => { window.__reportMode = 'weekly'; renderReport('weekly'); });
    btnMonthly.addEventListener('click', () => { window.__reportMode = 'monthly'; renderReport('monthly'); });
    let reportChart;
    async function renderReport(mode){
        const url = mode === 'weekly'
            ? `/api/reports/weekly?weeks=12`
            : `/api/reports/monthly?months=12`;
        const res = await fetch(url, { headers: { 'X-ANON-ID': anonId } });
        const data = await res.json(); // [{period,totalSeconds,dayCount,avgSecPerDay}]
        const labels = data.map(d => d.period);
        const hours  = data.map(d => Math.round((d.totalSeconds || 0)/3600));
        const totalSec = data.reduce((a,b)=> a + (b.totalSeconds || 0), 0);
        const avgSec   = data.length ? Math.round(data.reduce((a,b)=> a + (b.avgSecPerDay || 0), 0) / data.length) : 0;
        kpiTotal.textContent = secToHMS(totalSec);
        kpiAvg.textContent   = `${avgSec}ì´ˆ`;
        rangeLabel.textContent = mode === 'weekly' ? 'ìµœê·¼ 12ì£¼' : 'ìµœê·¼ 12ê°œì›”';
        if (reportChart) reportChart.destroy();
        const ctx = reportCanvas.getContext('2d');
        reportChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: mode === 'weekly' ? 'ì£¼ê°„ ì´ ì§‘ì¤‘(ì‹œê°„)' : 'ì›”ê°„ ì´ ì§‘ì¤‘(ì‹œê°„)', data: hours }] },
            options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
        });
        reportCanvas.parentElement.style.height = '360px';
    }

    /* =========================
       ëŒ€ì‹œë³´ë“œ ì•¡ì…˜: ì…ê¸ˆ/ì •ì‚°
    ==========================*/
    let currentSessionId = null, tickTimer = null, startedAtMs = null;

    async function onDeposit() {
        try {
            btnDeposit.disabled = true;
            const res = await fetch('/api/sessions/deposit', { method: 'POST', headers: { 'X-ANON-ID': anonId } });
            if (res.status === 409){ showToast('ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ì„¸ì…˜ì´ ìˆìŠµë‹ˆë‹¤.', true); btnDeposit.disabled = false; return; }
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json(); // {sessionId, startedAt, ...}
            currentSessionId = data.sessionId;
            startedAtMs = Date.parse(data.startedAt ?? data.createdAt);
            setStatusRunning(); startTick(); showToast('ì…ê¸ˆì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨');
        } catch (e) { showToast('ì…ê¸ˆ ì‹¤íŒ¨: ' + (e.message || e), true); btnDeposit.disabled = false; }
    }
    async function onSettle() {
        if (!currentSessionId){ showToast('ì§„í–‰ ì¤‘ì¸ ì…ê¸ˆ(ì§‘ì¤‘)ì´ ì—†ìŠµë‹ˆë‹¤.', true); return; }
        try {
            btnSettle.disabled = true;
            const res = await fetch(`/api/sessions/settle?sessionId=${currentSessionId}`, { method: 'POST' });
            if (res.status === 409){ showToast('ì´ë¯¸ ì¢…ë£Œëœ ì„¸ì…˜ì…ë‹ˆë‹¤.', true); btnSettle.disabled = false; return; }
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json(); // {durationSec,...}
            stopTick(); setStatusIdle();
            // ì •ì‚° í›„ ìš”ì•½ë“¤ ê°±ì‹ 
            await fetchTodaySummary();
            await fetchThisWeekTotal();
            await fetchThisMonthTotal();
            await fetchGoalProgressDaily();
            showToast(`ì •ì‚° ì™„ë£Œ! ì´ë²ˆ ì…ê¸ˆ: ${fmtSec(data.durationSec || 0)} â±ï¸`);
        } catch (e) { showToast('ì •ì‚° ì‹¤íŒ¨: ' + (e.message || e), true); btnSettle.disabled = false; }
    }
    function setStatusRunning(){ statusPill.textContent='ì…ê¸ˆ ì¤‘'; statusPill.style.background='rgba(34,197,94,.15)'; statusPill.style.borderColor='rgba(34,197,94,.35)'; btnSettle.disabled=false; btnDeposit.disabled=true; }
    function setStatusIdle(){ statusPill.textContent='ëŒ€ê¸° ì¤‘'; statusPill.style.background='rgba(255,255,255,.06)'; statusPill.style.borderColor='rgba(255,255,255,.12)'; btnSettle.disabled=true; btnDeposit.disabled=false; liveTimerEl.textContent='00:00:00'; currentSessionId=null; startedAtMs=null; }
    function startTick(){ if (!startedAtMs) startedAtMs=Date.now(); liveTimerEl.textContent=fmtSec(Math.floor((Date.now()-startedAtMs)/1000)); tickTimer=setInterval(()=>{ const sec=Math.floor((Date.now()-startedAtMs)/1000); liveTimerEl.textContent=fmtSec(sec); },1000); }
    function stopTick(){ if (tickTimer) clearInterval(tickTimer); }

    /* =========================
       ëŒ€ì‹œë³´ë“œ ìš”ì•½: API í˜¸ì¶œ
    ==========================*/
    // ì˜¤ëŠ˜ ìš”ì•½
    async function fetchTodaySummary(){
        const d = new Date();
        const yyyy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
        const dateStr = `${yyyy}-${mm}-${dd}`;
        try{
            const res = await fetch(`/api/reports/summary?date=${dateStr}`, { headers: {'X-ANON-ID': anonId} });
            if(res.ok){
                const json = await res.json(); // { targetDate, totalSec } ë˜ëŠ” { totalSeconds }
                todayTotal.textContent = fmtSec((json.totalSec ?? json.totalSeconds) || 0);
            } else { todayTotal.textContent = '--:--:--'; }
        }catch(_){ todayTotal.textContent = '--:--:--'; }
    }
    // ì´ë²ˆ ì£¼ í•©ê³„
    async function fetchThisWeekTotal(){
        try{
            const res = await fetch(`/api/reports/weekly?weeks=1`, { headers: {'X-ANON-ID': anonId} });
            const arr = res.ok ? await res.json() : [];
            const sec = Array.isArray(arr) && arr.length ? (arr[0].totalSeconds || 0) : 0;
            thisWeekTotal.textContent = fmtSec(sec);
        }catch(_){ thisWeekTotal.textContent='--:--:--'; }
    }
    // ì´ë²ˆ ë‹¬ í•©ê³„
    async function fetchThisMonthTotal(){
        try{
            const res = await fetch(`/api/reports/monthly?months=1`, { headers: {'X-ANON-ID': anonId} });
            const arr = res.ok ? await res.json() : [];
            const sec = Array.isArray(arr) && arr.length ? (arr[0].totalSeconds || 0) : 0;
            thisMonthTotal.textContent = fmtSec(sec);
        }catch(_){ thisMonthTotal.textContent='--:--:--'; }
    }
    // ì˜¤ëŠ˜ ëª©í‘œ ì§„í–‰ë¥  (ë¯¸êµ¬í˜„ì´ë©´ "ë¯¸ì„¤ì •")
    async function fetchGoalProgressDaily(){
        try{
            const res = await fetch(`/api/goals/progress?period=daily`, { headers: {'X-ANON-ID': anonId} });
            if(!res.ok){ setGoalUnset(); return; }
            const json = await res.json(); // { targetSeconds, achievedSeconds, progress(0~1) }
            if (!json || json.targetSeconds == null){ setGoalUnset(); return; }
            const pct = Math.min(100, Math.round((json.progress ?? (json.achievedSeconds/json.targetSeconds))*100));
            goalPct.textContent = `${pct}%`;
            goalBar.style.width = `${pct}%`;
            goalDesc.textContent = `ì˜¤ëŠ˜ ${fmtSec(json.achievedSeconds||0)} / ëª©í‘œ ${fmtSec(json.targetSeconds||0)}`;
        }catch(_){ setGoalUnset(); }
    }
    function setGoalUnset(){
        goalPct.textContent = 'ë¯¸ì„¤ì •';
        goalBar.style.width = '0%';
        goalDesc.textContent = 'ëª©í‘œë¥¼ ì„¤ì •í•´ ë³´ì„¸ìš”.';
    }

    /* =========================
       ê³µí†µ ìœ í‹¸
    ==========================*/
    function showToast(msg, error=false){
        toastEl.textContent = msg;
        toastEl.style.borderColor = error ? 'rgba(239,68,68,.5)' : 'rgba(56,189,248,.5)';
        toastEl.classList.add('show');
        setTimeout(()=>toastEl.classList.remove('show'), 2200);
    }
    function maskAnon(id){ if(!id) return 'anon-****'; const tail=id.slice(-4).toUpperCase(); return 'anon-'+tail; }
    function fmtSec(s){ const h=String(Math.floor(s/3600)).padStart(2,'0'); const m=String(Math.floor((s%3600)/60)).padStart(2,'0'); const sec=String(Math.floor(s%60)).padStart(2,'0'); return `${h}:${m}:${sec}`; }
    function secToHMS(sec){ const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); return `${h}ì‹œê°„ ${m}ë¶„`; }

    // ê°„ë‹¨ ULID ìƒì„±ê¸° (Crockford Base32)
    function generateULID(){
        const ENCODING = "0123456789ABCDEFGHJKMNPQRSTVWXYZ";
        function rand(n){ const bytes=new Uint8Array(n); (crypto.getRandomValues||window.msCrypto.getRandomValues).call(crypto,bytes); return Array.from(bytes); }
        const time = Date.now(); let t=time; const timeChars=[];
        for(let i=0;i<10;i++){ timeChars.push(ENCODING[t%32]); t=Math.floor(t/32); }
        const randomBytes = rand(16); const randChars=[]; let bits=0,val=0;
        for (let i=0;i<randomBytes.length;i++){ val=(val<<8)|randomBytes[i]; bits+=8; while(bits>=5){ bits-=5; randChars.push(ENCODING[(val>>>bits)&31]); } }
        while(randChars.length<16) randChars.push('0');
        return timeChars.reverse().join('') + randChars.slice(0,16).join('');
    }
</script>
</body>
</html>
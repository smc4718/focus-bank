<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Focus Bank - 디지털 집중력 은행</title>
    <style>
        :root { --bg:#0f172a; --card:#111827; --muted:#9ca3af; --txt:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --brand:#38bdf8; }
        *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,AppleSDGothicNeo,'Noto Sans KR',Segoe UI,Roboto,Arial;background:linear-gradient(120deg,#0b1220,#10192b)}
        .wrap{max-width:960px;margin:0 auto;padding:28px}
        .app-title{display:flex;align-items:center;gap:12px;color:#fff}
        .logo{font-size:28px}
        .subtitle{color:var(--muted);margin-top:4px}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px}
        .card{background:rgba(17,24,39,.8);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:18px;color:var(--txt);box-shadow:0 10px 30px rgba(0,0,0,.25)}
        .section-title{margin:0 0 10px 0;color:#fff;font-weight:700;font-size:18px}
        .row{display:flex;justify-content:space-between;align-items:center;margin:10px 0}
        .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:8px 12px;background:rgba(255,255,255,.06);color:#fff}
        .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
        .btns{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
        button{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:700;color:#0b1020;transition:.2s}
        .btn-deposit{background:var(--accent)}
        .btn-settle{background:var(--danger)}
        .btn-deposit:disabled,.btn-settle:disabled{opacity:.5;cursor:not-allowed}
        .balance{font-size:28px;font-weight:800;color:#fff}
        .muted{color:var(--muted);font-size:13px}
        .toast{position:fixed;right:20px;bottom:20px;background:#111827;color:#fff;border:1px solid rgba(255,255,255,.12);padding:12px 16px;border-radius:12px;opacity:0;transform:translateY(10px);transition:.2s}
        .toast.show{opacity:1;transform:none}
        .hero{margin-top:18px;display:flex;gap:10px;align-items:center;color:#cbd5e1}
        .hero b{color:#fff}
        .timer{font-variant-numeric:tabular-nums}
        .footer{margin-top:18px;color:#6b7280;font-size:12px}
        @media (max-width:800px){.grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="wrap">
    <div class="app-title">
        <div class="logo">🏦</div>
        <div>
            <h1 style="margin:0;color:#fff;">Focus Bank</h1>
            <div class="subtitle">집중 시간을 돈처럼 <b>입금/정산</b>하세요</div>
        </div>
    </div>

    <!-- 사용자/세션 상태 -->
    <div class="grid">
        <div class="card">
            <h2 class="section-title">내 정보</h2>
            <div class="row">
                <div>식별자</div>
                <div id="anonDisplay" class="pill mono">anon-????</div>
            </div>
            <div class="row">
                <div>현재 상태</div>
                <div id="statusPill" class="pill">대기 중</div>
            </div>
            <div class="row">
                <div>진행 타이머</div>
                <div id="liveTimer" class="mono timer">00:00:00</div>
            </div>
            <div class="btns">
                <button id="btnDeposit" class="btn-deposit">입금하기</button>
                <button id="btnSettle" class="btn-settle" disabled>정산하기</button>

            </div>
            <div class="hero">
                💡 <span>입금은 집중 시작, 정산은 종료를 의미해요.</span>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">일일 입금된 집중</h2>
            <div class="balance" id="todayTotal">--:--:--</div>
            <div class="muted">오늘 누적 집중 시간</div>
        </div>
    </div>

    <div class="footer">© Focus Bank · 단일 페이지 대시보드 (Thymeleaf + JS)</div>
</div>

<div id="toast" class="toast"></div>

<script>
    // ====== 간단 ULID 생성 (클라이언트 최초 진입 시) ======
    // 서버에서 생성/전달해도 됨. 이 코드는 라이브러리 없이 가벼운 버전.
    (function ensureAnon() {
        let anonId = localStorage.getItem('anonId');
        if (!anonId) {
            anonId = generateULID();
            localStorage.setItem('anonId', anonId);
            // ⚠️ 서버는 이 anonId가 anonymous_user 테이블에 존재해야 합니다.
            // 초기엔 수동 시드, 이후엔 서버에서 '없으면 생성' 로직/엔드포인트 추가 권장.
        }
    })();

    // ====== 상태/DOM ======
    const anonId = localStorage.getItem('anonId');
    const anonDisplay = document.getElementById('anonDisplay');
    const statusPill  = document.getElementById('statusPill');
    const liveTimerEl = document.getElementById('liveTimer');
    const btnDeposit  = document.getElementById('btnDeposit');
    const btnSettle   = document.getElementById('btnSettle');
    const toastEl     = document.getElementById('toast');
    const todayTotal  = document.getElementById('todayTotal');

    let currentSessionId = null;
    let tickTimer = null;
    let startedAtMs = null;

    // 표시용 마스킹
    anonDisplay.textContent = maskAnon(anonId);

    // 버튼 이벤트
    btnDeposit.addEventListener('click', onDeposit);
    btnSettle.addEventListener('click', onSettle);

    // 일일 요약
    fetchTodaySummary();

    // ====== 액션: 입금(집중 시작) ======
    async function onDeposit() {
        try {
            btnDeposit.disabled = true;
            const res = await fetch('/api/sessions/deposit', {
                method: 'POST',
                headers: { 'X-ANON-ID': anonId }
            });

            if (res.status === 409) {
                // 백엔드에서 Conflict 응답 (이미 열린 세션)
                showToast('이미 진행 중인 세션이 있습니다.', true);
                btnDeposit.disabled = false;
                return;
            }

            if (!res.ok) {
                throw new Error(await res.text());
            }

            const data = await res.json(); // FocusSessionDto
            currentSessionId = data.sessionId;
            startedAtMs = Date.parse(data.startedAt ?? data.createdAt);
            setStatusRunning();
            startTick();
            showToast('입금이 시작되었습니다! ✨');
        } catch (e) {
            showToast('입금 실패: ' + (e.message || e), true);
            btnDeposit.disabled = false;
        }
    }

    // ====== 액션: 정산(집중 종료) ======
    async function onSettle() {
        if (!currentSessionId) {
            showToast('진행 중인 입금(집중)이 없습니다.', true);
            return;
        }
        try {
            btnSettle.disabled = true;
            const res = await fetch(`/api/sessions/settle?sessionId=${currentSessionId}`, { method: 'POST' });

            if (res.status === 409) {
                // 백엔드에서 Conflict 응답 (이미 종료된 세션)
                showToast('이미 종료된 세션입니다.', true);
                btnSettle.disabled = false;
                return;
            }

            if (!res.ok) {
                throw new Error(await res.text());
            }

            const data = await res.json();
            stopTick();
            setStatusIdle();
            // 집중 완료 후 오늘 요약 자동 갱신
            await fetchTodaySummary();
            showToast(`정산 완료! 이번 입금: ${fmtSec(data.durationSec || 0)} ⏱️`);
        } catch (e) {
            showToast('정산 실패: ' + (e.message || e), true);
            btnSettle.disabled = false;
        }
    }

    // ====== 상태 전환 / 타이머 ======
    function setStatusRunning() {
        statusPill.textContent = '입금 중';
        statusPill.style.background = 'rgba(34,197,94,.15)';
        statusPill.style.borderColor = 'rgba(34,197,94,.35)';
        btnSettle.disabled = false;
        btnDeposit.disabled = true;
    }

    function setStatusIdle() {
        statusPill.textContent = '대기 중';
        statusPill.style.background = 'rgba(255,255,255,.06)';
        statusPill.style.borderColor = 'rgba(255,255,255,.12)';
        btnSettle.disabled = true;
        btnDeposit.disabled = false;
        liveTimerEl.textContent = '00:00:00';
        currentSessionId = null;
        startedAtMs = null;
    }

    function startTick() {
        if (!startedAtMs) startedAtMs = Date.now();
        liveTimerEl.textContent = fmtSec(Math.floor((Date.now() - startedAtMs)/1000));
        tickTimer = setInterval(() => {
            const sec = Math.floor((Date.now() - startedAtMs)/1000);
            liveTimerEl.textContent = fmtSec(sec);
        }, 1000);
    }
    function stopTick() { if (tickTimer) clearInterval(tickTimer); }

    // ====== 유틸 ======
    function showToast(msg, error=false){
        toastEl.textContent = msg;
        toastEl.style.borderColor = error ? 'rgba(239,68,68,.5)' : 'rgba(56,189,248,.5)';
        toastEl.classList.add('show');
        setTimeout(()=>toastEl.classList.remove('show'), 2200);
    }

    function maskAnon(id){
        if(!id) return 'anon-****';
        const tail = id.slice(-4).toUpperCase();
        return 'anon-' + tail;
        // (고려사항 : 닉네임이 있다면 서버 응답에서 displayName 내려 활용해도 좋음)
    }

    function fmtSec(s){
        const h = Math.floor(s/3600).toString().padStart(2,'0');
        const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
        const sec = Math.floor(s%60).toString().padStart(2,'0');
        return `${h}:${m}:${sec}`;
    }

    // 간단한 ULID 생성기 (Crockford Base32)
    function generateULID(){
        const ENCODING = "0123456789ABCDEFGHJKMNPQRSTVWXYZ";
        function encodeTime(t){
            let out = "";
            for(let i=9;i>=0;i--){ out = ENCODING[(t >>> (i*5)) & 31] + out; }
            return out;
        }
        function rand(n){
            const bytes = new Uint8Array(n);
            (crypto.getRandomValues || window.msCrypto.getRandomValues).call(crypto, bytes);
            return Array.from(bytes);
        }
        const time = Date.now();
        // time(48비트) → 10 chars, random(80비트) → 16 chars
        // JS 비트 연산 한계로 쉬운 방식으로 인코딩
        let t = time;
        const timeChars = [];
        for(let i=0;i<10;i++){
            timeChars.push(ENCODING[t % 32]); t = Math.floor(t/32);
        }
        const randomBytes = rand(16);
        const randChars = [];
        let carry = 0, bits = 0, val = 0;
        for (let i=0;i<randomBytes.length;i++){
            val = (val << 8) | randomBytes[i];
            bits += 8;
            while(bits >= 5){
                bits -= 5;
                randChars.push(ENCODING[(val >>> bits) & 31]);
            }
        }
        while(randChars.length < 16) randChars.push('0');
        return timeChars.reverse().join('') + randChars.slice(0,16).join('');
    }

    // 일일 집중 요약 API 호출
    async function fetchTodaySummary(){
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const dateStr = `${yyyy}-${mm}-${dd}`;
        try{
            const res = await fetch(`/api/reports/summary?date=${dateStr}`, { headers: {'X-ANON-ID': anonId} });
            if(res.ok){
                const json = await res.json(); // { targetDate, totalSec }
                todayTotal.textContent = fmtSec(json.totalSec ?? 0);
            }else{
                todayTotal.textContent = '--:--:--';
            }
        }catch(_){
            todayTotal.textContent = '--:--:--';
        }
    }
</script>
</body>
</html>
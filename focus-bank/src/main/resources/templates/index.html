<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Focus Bank - ë””ì§€í„¸ ì§‘ì¤‘ë ¥ ì€í–‰</title>

    <style>
        /* ==== ì „ì—­ ìƒ‰ìƒ, í…Œë§ˆ ë³€ìˆ˜ ==== */
        :root {
            --bg-outer-1:#2b3445;      /* ì–´ë‘ìš´ ë©”íƒˆë¦­ ë¸”ë£¨ */
            --bg-outer-2:#121820;
            --atm-outer-1:#245050;     /* ATM ë³¸ì²´(ë©”íƒˆ í‹´íŠ¸) */
            --atm-outer-2:#123232;
            --screen-1:#001400;        /* í™”ë©´(ì–´ë‘ìš´ ë…¹ìƒ‰ CRT ëŠë‚Œ) */
            --screen-2:#0a121a;

            --brand:#22c55e;           /* ë©”ì¸ ì´ˆë¡(ë„¤ì˜¨) */
            --danger:#ef4444;
            --muted:#9ca3af;
            --txt:#e5e7eb;
        }
        *{box-sizing:border-box}

        body{
            margin:0;
            font-family:ui-sans-serif,system-ui,AppleSDGothicNeo,'Noto Sans KR',Segoe UI,Roboto,Arial;
            background:linear-gradient(145deg,var(--bg-outer-1),var(--bg-outer-2));
            color:var(--txt);
        }

        /* ==== ATM ì™¸ë¶€ í”„ë ˆì„ ==== */
        .atm-frame{
            max-width:1100px;
            margin:40px auto;
            padding:40px 20px 60px;
            border-radius:12px;
            background:linear-gradient(160deg,var(--atm-outer-1),var(--atm-outer-2));
            border:6px solid #1a2f2f;
            box-shadow:
                    0 8px 30px rgba(0,0,0,.8),
                    inset 0 0 30px rgba(0,0,0,.55);
            position:relative;
        }

        /* ==== ìƒë‹¨ ATM ë¡œê³  (ìš”ì²­í•œ ë”¥ê·¸ë¦° ìŠ¤íƒ€ì¼) ==== */
        .atm-logo{
            text-align:center;
            background:#1a3d2f; /* ë”¥ ê·¸ë¦° */
            color:#22c55e;      /* ë„¤ì˜¨ ì´ˆë¡ ê¸€ì”¨ */
            font-weight:bold;
            font-size:28px;
            letter-spacing:2px;
            padding:14px 0;
            border-radius:8px;
            border:3px solid #14532d;
            margin-bottom:20px;
            text-shadow:0 0 6px rgba(34,197,94,0.7);
            user-select:none;
        }

        /* ==== ATM ë‚´ë¶€ í™”ë©´ ==== */
        .wrap{
            padding:28px;
            border-radius:12px;
            background:linear-gradient(160deg,var(--screen-1),var(--screen-2));
            border:4px solid var(--brand);
            box-shadow:
                    inset 0 0 40px rgba(0,0,0,.8),
                    0 0 30px rgba(34,197,94,.25);
        }

        .app-title{display:flex;align-items:center;gap:12px;color:#fff}
        .logo{font-size:28px}
        .subtitle{color:var(--muted);margin-top:4px}

        /* ==== íƒ­ ==== */
        .tabs{display:flex;gap:8px;margin-top:14px}
        .tab{
            border:1px solid rgba(34,197,94,.4);
            border-radius:999px;
            padding:8px 12px;
            background:rgba(34,197,94,.1);
            color:var(--brand);
            cursor:pointer;
            user-select:none;
        }
        .tab.active{background:var(--brand);color:#001900}

        /* ==== ì¹´ë“œ / ê·¸ë¦¬ë“œ ==== */
        .grid{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
            gap:18px;
            margin-top:20px
        }
        .card{
            background:linear-gradient(145deg,#132020,#0e1515);
            border:2px solid var(--brand);
            border-radius:12px;
            padding:18px;
            transition:.25s;
            box-shadow:0 0 15px rgba(34,197,94,.3);
        }
        .card:hover{
            transform:translateY(-3px);
            box-shadow:
                    0 0 25px rgba(34,197,94,.8),
                    inset 0 0 22px rgba(34,197,94,.28);
        }

        .section-title{margin:0 0 10px 0;color:#fff;font-weight:700;font-size:18px}
        .row{display:flex;justify-content:space-between;align-items:center;margin:10px 0}
        .row-left{display:flex;align-items:center;gap:8px}

        /* ==== pill ==== */
        .pill{
            display:inline-flex;align-items:center;gap:6px;
            border:1px solid rgba(34,197,94,.6);
            border-radius:999px;
            padding:6px 12px;
            background:rgba(34,197,94,.15);
            color:var(--brand);
            font-weight:600;
            text-shadow:0 0 6px rgba(34,197,94,.9);
        }
        .display-pill{
            background:linear-gradient(90deg,#16a34a,#22c55e);
            color:#001b0e;border-color:transparent;
            text-shadow:none
        }
        .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

        /* ==== ë²„íŠ¼ ==== */
        .btns{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
        button{
            cursor:pointer;
            border:2px solid var(--brand);
            border-radius:10px;
            padding:10px 14px;
            font-weight:700;
            color:var(--brand);
            background:#0d1b1e;
            transition:.2s;
            box-shadow:inset 0 0 8px rgba(34,197,94,.5)
        }
        button:hover{
            background:var(--brand);
            color:#0d1b1e;
            box-shadow:0 0 15px var(--brand),0 0 35px #bbf7d0
        }
        .btn-deposit{ /* ì‹œê° ê°•ì¡°ìš© ë³„ë„ í´ë˜ìŠ¤ë§Œ ìœ ì§€ */ }
        .btn-settle{
            border-color:var(--danger);
            color:var(--danger);
            box-shadow:inset 0 0 8px rgba(239,68,68,.4)
        }
        .btn-settle:hover{
            background:var(--danger);color:#fff;
            box-shadow:0 0 15px var(--danger),0 0 35px #fecaca
        }
        .btn-ghost{
            border:1px solid rgba(255,255,255,.25);
            color:#fff;background:transparent
        }
        .btn-brand{
            background:var(--brand);color:#062012;border-color:var(--brand)
        }
        .btn-deposit:disabled,.btn-settle:disabled{opacity:.5;cursor:not-allowed}

        /* ==== ë°ì´í„° ê°•ì¡° ==== */
        .balance{font-size:28px;font-weight:800;color:#fff;text-shadow:0 0 8px rgba(34,197,94,.7)}
        .muted{color:var(--muted);font-size:13px}
        .hero{margin-top:18px;display:flex;gap:10px;align-items:center;color:#cbd5e1}
        .timer{font-variant-numeric:tabular-nums}

        /* ==== ëª©í‘œ ì§„í–‰ë¥  ë°” ==== */
        .progress{height:12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(34,197,94,.5);overflow:hidden}
        .progress .bar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#bbf7d0)}

        /* ==== ë­í‚¹ ==== */
        table{width:100%;border-collapse:collapse;margin-top:6px}
        table th,table td{padding:6px 4px}
        table thead th{color:#8fb7a0;font-weight:700;border-bottom:1px solid rgba(34,197,94,.35);text-align:left}
        table tbody tr{border-top:1px solid rgba(34,197,94,.16)}
        table tbody tr:first-child{border-top:none}
        table td:last-child{text-align:right;font-variant-numeric:tabular-nums}

        #weeklyRanking tbody tr:nth-child(1) td:first-child,
        #overallRanking tbody tr:nth-child(1) td:first-child{color:gold;font-weight:bold}
        #weeklyRanking tbody tr:nth-child(2) td:first-child,
        #overallRanking tbody tr:nth-child(2) td:first-child{color:silver;font-weight:bold}
        #weeklyRanking tbody tr:nth-child(3) td:first-child,
        #overallRanking tbody tr:nth-child(3) td:first-child{color:#cd7f32;font-weight:bold}

        /* ==== ëª¨ë‹¬ ê³µí†µ ==== */
        .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
        .modal{
            background:#111827;border:2px solid var(--brand);border-radius:16px;
            max-width:420px;width:100%;padding:18px;color:#fff;
            box-shadow:0 0 20px rgba(34,197,94,.6)
        }
        .modal h3{margin:0 0 12px 0}
        .modal .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
        .modal input,.modal select{padding:10px 12px;border-radius:10px;border:1px solid rgba(34,197,94,.5);background:rgba(34,197,94,.1);color:#e5e7eb}
        .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:6px}
        .show-flex{display:flex}

        /* ==== í† ìŠ¤íŠ¸ ==== */
        .toast{position:fixed;right:20px;bottom:20px;background:#111827;color:#fff;border:1px solid rgba(255,255,255,.12);padding:12px 16px;border-radius:12px;opacity:0;transform:translateY(10px);transition:.2s;z-index:60}
        .toast.show{opacity:1;transform:none}

        /* ==== ë°˜ì‘í˜• ==== */
        @media (max-width:800px){.grid{grid-template-columns:1fr}}

        .footer{margin-top:18px;color:#6b7280;font-size:12px;text-align:center}
    </style>
</head>
<body>
<div class="atm-frame">
    <div class="atm-logo">ATM</div>

    <div class="wrap">
        <!-- ìƒë‹¨ ë¡œê³  / íƒ€ì´í‹€ ì˜ì—­ -->
        <div class="app-title">
            <div class="logo">ğŸ¦</div>
            <div>
                <h1 style="margin:0;color:#fff;">Focus Bank</h1>
                <div class="subtitle">ì§‘ì¤‘ ì‹œê°„ì„ ëˆì²˜ëŸ¼ <b>ì…ê¸ˆ/ì •ì‚°</b>í•˜ì„¸ìš”</div>
            </div>
        </div>

        <!-- íƒ­ -->
        <div class="tabs" aria-label="í™”ë©´ íƒ­">
            <div id="tab-dashboard" class="tab active">ëŒ€ì‹œë³´ë“œ</div>
        </div>

        <!-- ===== ëŒ€ì‹œë³´ë“œ ë³¸ë¬¸ ===== -->
        <section id="view-dashboard" aria-labelledby="tab-dashboard">
            <div class="grid">
                <!-- ë‚´ ì •ë³´ -->
                <div class="card">
                    <h2 class="section-title">ë‚´ ì •ë³´</h2>

                    <div class="row">
                        <div class="row-left"><div>í‘œì‹œëª…</div></div>
                        <div>
                            <span id="displayName" class="pill display-pill">ë‹‰ë„¤ì„ ë¯¸ì„¤ì •</span>
                            <button id="btnOpenNickname" class="btn-ghost" style="margin-left:8px">ë‹‰ë„¤ì„ ì„¤ì •</button>
                        </div>
                    </div>

                    <div class="row" id="anonRow">
                        <div>ì‹ë³„ì</div>
                        <div id="anonDisplay" class="pill mono">anon-????</div>
                    </div>

                    <div class="row">
                        <div>í˜„ì¬ ìƒíƒœ</div>
                        <div id="statusPill" class="pill">ëŒ€ê¸° ì¤‘</div>
                    </div>

                    <div class="row">
                        <div>ì§„í–‰ íƒ€ì´ë¨¸</div>
                        <div id="liveTimer" class="mono timer">00:00:00</div>
                    </div>

                    <div class="btns" aria-label="ì§‘ì¤‘ ì„¸ì…˜ ì¡°ì‘">
                        <button id="btnDeposit" class="btn-deposit">ì…ê¸ˆí•˜ê¸°</button>
                        <button id="btnSettle" class="btn-settle" disabled>ì •ì‚°í•˜ê¸°</button>
                    </div>

                    <div class="hero">ğŸ’¡ <span>ì…ê¸ˆì€ ì§‘ì¤‘ ì‹œì‘, ì •ì‚°ì€ ì¢…ë£Œë¥¼ ì˜ë¯¸í•´ìš”.</span></div>
                </div>

                <!-- ì˜¤ëŠ˜ í•©ê³„ -->
                <div class="card">
                    <h2 class="section-title">ì¼ì¼ ì…ê¸ˆëœ ì§‘ì¤‘</h2>
                    <div class="balance" id="todayTotal">--:--:--</div>
                    <div class="muted">ì˜¤ëŠ˜ ëˆ„ì  ì§‘ì¤‘ ì‹œê°„</div>
                </div>
            </div>

            <div class="grid">
                <!-- ì£¼/ì›” í•©ê³„ -->
                <div class="card">
                    <h2 class="section-title">ì´ë²ˆ ì£¼ í•©ê³„</h2>
                    <div class="balance" id="thisWeekTotal">--:--:--</div>
                    <div class="muted">ì›”ìš”ì¼~ì˜¤ëŠ˜ ê¸°ì¤€(ISO ì£¼)</div>
                </div>

                <div class="card">
                    <h2 class="section-title">ì´ë²ˆ ë‹¬ í•©ê³„</h2>
                    <div class="balance" id="thisMonthTotal">--:--:--</div>
                    <div class="muted">1ì¼~ì˜¤ëŠ˜ ê¸°ì¤€</div>
                </div>

                <!-- ëª©í‘œ ì§„í–‰ë¥  -->
                <div class="card" style="grid-column:1/-1">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <h2 class="section-title" style="margin:0;">ëª©í‘œ ì§„í–‰ë¥ </h2>
                        <select id="goalViewPeriod" class="pill" style="margin-left:auto" aria-label="ëª©í‘œ ë³´ê¸° ê¸°ê°„ ì„ íƒ">
                            <option value="daily" selected>ì¼ê°„</option>
                            <option value="weekly">ì£¼ê°„</option>
                            <option value="monthly">ì›”ê°„</option>
                        </select>
                        <button id="btnOpenGoal" class="btn-ghost">ëª©í‘œ ì„¤ì •</button>
                    </div>

                    <div class="row">
                        <div class="muted">ë‹¬ì„±ë¥ </div>
                        <div id="goalPct" class="pill">ë¯¸ì„¤ì •</div>
                    </div>

                    <div class="progress" aria-label="ëª©í‘œ ì§„í–‰ ë°”">
                        <div id="goalBar" class="bar"></div>
                    </div>
                    <div class="muted" id="goalDesc" style="margin-top:8px;">ëª©í‘œë¥¼ ì„¤ì •í•´ ë³´ì„¸ìš”.</div>
                </div>

                <!-- ì˜¤ëŠ˜ì˜ ì„¸ì…˜ ë§‰ëŒ€ ì°¨íŠ¸ -->
                <div class="card" style="grid-column:1/-1">
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <h2 class="section-title" style="margin:0;">ê° íšŒì°¨ ì§‘ì¤‘ (ì˜¤ëŠ˜)</h2>
                        <div class="muted" id="sessionBarHint">ì§‘ì¤‘ ì‹œê°„(ë¶„)</div>
                    </div>
                    <div style="border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px;position:relative;">
                        <canvas id="sessionBarCanvas"></canvas>
                        <div id="sessionBarEmpty" class="muted" style="display:none;margin-top:6px;">ì˜¤ëŠ˜ ì„¸ì…˜ì´ ì•„ì§ ì—†ì–´ìš”.</div>
                    </div>
                </div>
            </div>

            <!-- ë­í‚¹ -->
            <div class="grid">
                <div class="card">
                    <h2 class="section-title">ì´ë²ˆ ì£¼ ë­í‚¹ ğŸ†</h2>
                    <table id="weeklyRanking">
                        <thead>
                        <tr>
                            <th style="text-align:left;">ìˆœìœ„</th>
                            <th style="text-align:left;">ì‚¬ìš©ì</th>
                            <th style="text-align:right;">ì§‘ì¤‘ì‹œê°„</th>
                        </tr>
                        </thead>
                        <tbody><!-- JS ì£¼ì… --></tbody>
                    </table>
                </div>

                <div class="card">
                    <h2 class="section-title">ëˆ„ì  ë­í‚¹ ğŸ¦</h2>
                    <table id="overallRanking">
                        <thead>
                        <tr>
                            <th style="text-align:left;">ìˆœìœ„</th>
                            <th style="text-align:left;">ì‚¬ìš©ì</th>
                            <th style="text-align:right;">ì§‘ì¤‘ì‹œê°„</th>
                        </tr>
                        </thead>
                        <tbody><!-- JS ì£¼ì… --></tbody>
                    </table>
                </div>
            </div>
        </section>

        <div class="footer">Â© Focus Bank Â· ë‹¨ì¼ í˜ì´ì§€ ëŒ€ì‹œë³´ë“œ (HTML, JS)</div>
    </div>
</div>

<!-- í† ìŠ¤íŠ¸ -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- ëª©í‘œ ì„¤ì • ëª¨ë‹¬ -->
<div id="goalModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="goalTitle">
        <h3 id="goalTitle">ëª©í‘œ ì„¤ì •</h3>

        <div class="field">
            <label for="goalPeriod">ê¸°ê°„</label>
            <select id="goalPeriod">
                <option value="DAILY">ì¼ê°„</option>
                <option value="WEEKLY">ì£¼ê°„</option>
                <option value="MONTHLY">ì›”ê°„</option>
            </select>
        </div>

        <div class="field">
            <label for="goalHours">ëª©í‘œ ì‹œê°„</label>
            <div style="display:flex;gap:8px;">
                <input id="goalHours" type="number" min="0" placeholder="ì‹œê°„(h)" style="flex:1;">
                <input id="goalMinutes" type="number" min="0" max="59" placeholder="ë¶„(m)" style="flex:1;">
            </div>
            <small class="muted">ì˜ˆ: 2ì‹œê°„ 30ë¶„ â†’ ê°ê° 2, 30 ì…ë ¥</small>
        </div>

        <div class="field">
            <label for="goalFrom">ì‹œì‘ì¼(ì„ íƒ)</label>
            <input id="goalFrom" type="date"/>
            <small class="muted">ë¹„ìš°ë©´ ì˜¤ëŠ˜ë¶€í„° ì ìš©</small>
        </div>

        <div class="actions">
            <button id="btnCloseGoal" class="btn-ghost">ì·¨ì†Œ</button>
            <button id="btnSaveGoal" class="btn-brand">ì €ì¥</button>
        </div>
    </div>
</div>

<!-- ë‹‰ë„¤ì„ ì„¤ì • ëª¨ë‹¬ -->
<div id="nicknameModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="nicknameTitle">
        <h3 id="nicknameTitle">ë‹‰ë„¤ì„ ì„¤ì •</h3>

        <div class="field">
            <label for="nickInput">ë‹‰ë„¤ì„</label>
            <input id="nickInput" type="text" inputmode="text" autocomplete="nickname" placeholder="ì˜ˆ: ì§‘ì¤‘ì¥ì¸" maxlength="16"/>
            <small class="muted">ê·œì¹™: 2~16ì, í•œê¸€/ì˜ë¬¸/ìˆ«ì/ë°‘ì¤„(_) ë§Œ í—ˆìš©. ê³µë°±/íŠ¹ìˆ˜ë¬¸ì ë¶ˆê°€</small>
        </div>

        <div class="field" style="margin-top:-4px">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <small id="nickCheckMsg" class="muted">ë‹‰ë„¤ì„ì€ ì–¸ì œë“  ë³€ê²½ ê°€ëŠ¥í•´ìš”. (íƒœê·¸ëŠ” ìë™ ë¶€ì—¬Â·ê³ ì •)</small>
            </div>
        </div>

        <div class="field" style="margin-top:-2px">
            <small class="muted">
                ê°™ì€ ë‹‰ë„¤ì„ì´ ì—¬ëŸ¬ ëª… ìˆì–´ë„ <b>íƒœê·¸</b>ê°€ ë‹¬ë¼ <b>ë‹‰ë„¤ì„#íƒœê·¸</b> ì¡°í•©ì€ ìœ ì¼í•©ë‹ˆë‹¤.
                ì˜ˆ) <span class="mono">ì§‘ì¤‘ì¥ì¸#0420</span>
            </small>
        </div>

        <div class="actions">
            <button id="btnCloseNickname" class="btn-ghost" type="button">ì·¨ì†Œ</button>
            <button id="btnSaveNick" class="btn-brand" type="button">ì €ì¥</button>
        </div>
    </div>
</div>

<script>
    /* ========= ìµëª… ID ========= */
    // ì²˜ìŒ ë°©ë¬¸ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ìµëª… ì‚¬ìš©ì ID(anonId)ê°€ ì—†ìœ¼ë©´ ìƒì„±
    (function ensureAnon() {
        let anonId = localStorage.getItem('anonId'); // ê¸°ì¡´ ì €ì¥ëœ anonId ë¶ˆëŸ¬ì˜¤ê¸°
        if (!anonId) {
            anonId = generateULID();                 // ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ULID ìƒì„±
            localStorage.setItem('anonId', anonId);  // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        }
    })();
    const anonId = localStorage.getItem('anonId');   // í•­ìƒ anonIdë¥¼ ì „ì—­ì—ì„œ ì“¸ ìˆ˜ ìˆê²Œ ë¶ˆëŸ¬ì˜´

    /* ========= DOM ìš”ì†Œ ìºì‹± ========= */
    // HTMLì—ì„œ ìì£¼ ì“°ëŠ” ìš”ì†Œë“¤ì„ ë¯¸ë¦¬ ë³€ìˆ˜ì— ë‹´ì•„ë‘ê¸°
    const anonDisplay = document.getElementById('anonDisplay');
    const statusPill  = document.getElementById('statusPill');
    const liveTimerEl = document.getElementById('liveTimer');
    const btnDeposit  = document.getElementById('btnDeposit');
    const btnSettle   = document.getElementById('btnSettle');
    const toastEl     = document.getElementById('toast');
    const todayTotal  = document.getElementById('todayTotal');

    const thisWeekTotal  = document.getElementById('thisWeekTotal');
    const thisMonthTotal = document.getElementById('thisMonthTotal');
    const goalPct        = document.getElementById('goalPct');
    const goalBar        = document.getElementById('goalBar');
    const goalDesc       = document.getElementById('goalDesc');

    const goalModal   = document.getElementById('goalModal');
    const btnOpenGoal = document.getElementById('btnOpenGoal');
    const btnCloseGoal= document.getElementById('btnCloseGoal');
    const btnSaveGoal = document.getElementById('btnSaveGoal');
    const goalPeriod  = document.getElementById('goalPeriod');
    const goalHours   = document.getElementById('goalHours');
    const goalMinutes = document.getElementById('goalMinutes');
    const goalFrom    = document.getElementById('goalFrom');
    const goalViewPeriod = document.getElementById('goalViewPeriod');

    // ë‹‰ë„¤ì„ ê´€ë ¨ DOM
    const displayNameEl  = document.getElementById('displayName');
    const btnOpenNickname= document.getElementById('btnOpenNickname');
    const btnCloseNickname=document.getElementById('btnCloseNickname');
    const btnSaveNick    = document.getElementById('btnSaveNick');
    const btnNickCheck   = document.getElementById('btnNickCheck');
    const nickInput      = document.getElementById('nickInput');
    const nickCheckMsg   = document.getElementById('nickCheckMsg');
    const nicknameModal  = document.getElementById('nicknameModal');

    // ë­í‚¹ ê´€ë ¨ DOM
    const weeklyRankingBody  = document.querySelector('#weeklyRanking tbody');
    const overallRankingBody = document.querySelector('#overallRanking tbody');

    // ì„¸ì…˜ë³„ ë§‰ëŒ€ ê·¸ë˜í”„ ê´€ë ¨ DOM
    const sessionBarCanvas = document.getElementById('sessionBarCanvas');
    const sessionBarEmpty  = document.getElementById('sessionBarEmpty');

    // ì‚¬ìš©ì ID ë§ˆìŠ¤í‚¹í•´ì„œ í™”ë©´ì— í‘œì‹œ (ex: anon-AB12)
    anonDisplay.textContent = maskAnon(anonId);

    /* ========= ì„¸ì…˜ë³„ ë§‰ëŒ€ ì°¨íŠ¸ ========= */

    // yì¶• ëˆˆê¸ˆ í¬ë§·í„° (ë¶„ â†’ "ì‹œê°„ ë¶„" í˜•íƒœë¡œ ë³€í™˜)
    function formatMinutesTick(v){
        const m = Math.round(Number(v)||0);
        if (m < 60) return `${m}ë¶„`;
        const h = Math.floor(m/60), mm = m%60;
        return mm === 0 ? `${h}ì‹œê°„` : `${h}ì‹œê°„ ${mm}ë¶„`;
    }

    /* ========= ì…ê¸ˆ/ì •ì‚° ========= */
    // í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì„¸ì…˜ ID / íƒ€ì´ë¨¸ í•¸ë“¤ëŸ¬ / ì‹œì‘ ì‹œê°„(ms)
    let currentSessionId = null, tickTimer = null, startedAtMs = null;

    // ì…ê¸ˆí•˜ê¸°(ì§‘ì¤‘ ì‹œì‘) ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì‹¤í–‰
    async function onDeposit() {
        try {
            btnDeposit.disabled = true; // ì¤‘ë³µ í´ë¦­ ë°©ì§€ (ë²„íŠ¼ ë¹„í™œì„±í™”)

            // ì„œë²„ì— POST ìš”ì²­ â†’ ìƒˆë¡œìš´ ì„¸ì…˜ ìƒì„±
            const res = await fetch('/api/sessions/deposit', {
                method: 'POST',
                headers: { 'X-ANON-ID': anonId } // ì‚¬ìš©ì ì‹ë³„ì ì „ë‹¬
            });

            // ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ì„¸ì…˜ì´ ìˆìœ¼ë©´ 409 Conflict ì‘ë‹µ â†’ ì•ˆë‚´ ë©”ì‹œì§€
            if (res.status === 409){
                showToast('ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ì„¸ì…˜ì´ ìˆìŠµë‹ˆë‹¤.', true);
                btnDeposit.disabled = false;
                return;
            }

            // ì‘ë‹µì´ ì‹¤íŒ¨í•˜ë©´ ì˜ˆì™¸ ì²˜ë¦¬
            if (!res.ok) throw new Error(await res.text());

            // ì •ìƒ ì‘ë‹µ â†’ ì„¸ì…˜ ì •ë³´ JSON íŒŒì‹±
            const data = await res.json();
            currentSessionId = data.sessionId;                       // ì„¸ì…˜ ID ì €ì¥
            startedAtMs = parseLocalDateTime(data.startedAt ?? data.createdAt).getTime(); // ì‹œì‘ ì‹œê°„ ê¸°ë¡

            // UI ìƒíƒœ ì—…ë°ì´íŠ¸: "ì…ê¸ˆ ì¤‘" í‘œì‹œ, íƒ€ì´ë¨¸ ì‹œì‘
            setStatusRunning();
            startTick();
            showToast('ì…ê¸ˆì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨');

            // ë¡œì»¬ ì„¸ì…˜ ë¡œê·¸ ê¸°ë¡ (ë¸Œë¼ìš°ì € ì €ì¥ì†Œ)
            logStart(currentSessionId, startedAtMs);

            // ì„¸ì…˜ ë§‰ëŒ€ ì°¨íŠ¸ ë‹¤ì‹œ ë Œë”ë§
            await renderSessionBars();
        } catch (e) {
            showToast('ì…ê¸ˆ ì‹¤íŒ¨: ' + (e.message || e), true);
            btnDeposit.disabled = false; // ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
        }
    }

    // ì •ì‚°í•˜ê¸°(ì§‘ì¤‘ ì¢…ë£Œ) ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì‹¤í–‰
    async function onSettle() {
        if (!currentSessionId){
            showToast('ì§„í–‰ ì¤‘ì¸ ì…ê¸ˆ(ì§‘ì¤‘)ì´ ì—†ìŠµë‹ˆë‹¤.', true);
            return;
        }
        try {
            btnSettle.disabled = true;

            // X-ANON-ID í—¤ë” ì¶”ê°€
            const res = await fetch(`/api/sessions/settle?sessionId=${currentSessionId}`, {
                method: 'POST',
                headers: { 'X-ANON-ID': anonId }
            });

            if (res.status === 409){
                showToast('ì´ë¯¸ ì¢…ë£Œëœ ì„¸ì…˜ì…ë‹ˆë‹¤.', true);
                btnSettle.disabled = false;
                return;
            }
            if (!res.ok) throw new Error(await res.text());

            const data = await res.json();

            // ì„¸ì…˜IDê°€ ì—†ì–´ì§€ê¸° ì „ì— ë¡œì»¬ ë¡œê·¸ì— ì¢…ë£Œ ê¸°ë¡
            const endedAt = Date.now();
            logEnd(currentSessionId, endedAt);

            // íƒ€ì´ë¨¸ ë¨¼ì € ë©ˆì¶”ê³  ìƒíƒœ ì „í™˜
            stopTick();
            setStatusIdle();

            await fetchTodaySummary();
            await fetchThisWeekTotal();
            await fetchThisMonthTotal();
            await fetchGoalProgress(goalViewPeriod.value || 'daily');

            showToast(`ì •ì‚° ì™„ë£Œ! ì´ë²ˆ ì…ê¸ˆ: ${fmtSec(data.durationSec || 0)} â±ï¸`);
            await renderSessionBars();
        } catch (e) {
            showToast('ì •ì‚° ì‹¤íŒ¨: ' + (e.message || e), true);
            btnSettle.disabled = false;
        }
    }

    // UI ìƒíƒœë¥¼ "ì…ê¸ˆ ì¤‘"ìœ¼ë¡œ ë³€ê²½
    function setStatusRunning(){
        statusPill.textContent='ì…ê¸ˆ ì¤‘';
        statusPill.style.background='rgba(34,197,94,.15)';
        statusPill.style.borderColor='rgba(34,197,94,.35)';
        btnSettle.disabled=false; // ì •ì‚° ë²„íŠ¼ í™œì„±í™”
        btnDeposit.disabled=true; // ì…ê¸ˆ ë²„íŠ¼ ë¹„í™œì„±í™”
        persistActiveSession();   // í˜„ì¬ ì„¸ì…˜ ìƒíƒœë¥¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    }

    // UI ìƒíƒœë¥¼ "ëŒ€ê¸° ì¤‘"ìœ¼ë¡œ ë³€ê²½
    function setStatusIdle(){
        stopTick();
        statusPill.textContent='ëŒ€ê¸° ì¤‘';
        statusPill.style.background='rgba(255,255,255,.06)';
        statusPill.style.borderColor='rgba(255,255,255,.12)';
        btnSettle.disabled=true;
        btnDeposit.disabled=false;
        liveTimerEl.textContent='00:00:00';
        currentSessionId=null;
        startedAtMs=null;
        persistActiveSession();
    }

    // ì‹¤ì‹œê°„ íƒ€ì´ë¨¸ ì‹œì‘
    function startTick(){
        // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
        if (tickTimer) { clearInterval(tickTimer); tickTimer = null; }

        // ì‹œì‘ ì‹œê°„ì´ ì—†ìœ¼ë©´ ì‹œì‘í•˜ì§€ ì•ŠìŒ (ë°©ì–´)
        if (startedAtMs == null) return;

        // ì¦‰ì‹œ 1íšŒ í‘œì‹œ
        liveTimerEl.textContent = fmtSec(Math.floor((Date.now()-startedAtMs)/1000));

        // 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        tickTimer = setInterval(()=>{
            if (startedAtMs == null) { // Idle ì „í™˜ ë°©ì–´
                clearInterval(tickTimer);
                tickTimer = null;
                return;
            }
            const sec = Math.floor((Date.now()-startedAtMs)/1000);
            liveTimerEl.textContent = fmtSec(sec);
        }, 1000);

        startLiveUiTick();
        persistActiveSession();
    }

    // ì‹¤ì‹œê°„ íƒ€ì´ë¨¸ ì •ì§€
    function stopTick(){
        if (tickTimer) { clearInterval(tickTimer); tickTimer = null; }
        stopLiveUiTick();
    }


    /* ========= ì˜¤ëŠ˜ ìš”ì•½ ========= */
    // ì˜¤ëŠ˜ í•˜ë£¨ ëˆ„ì  ì§‘ì¤‘ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    async function fetchTodaySummary(){
        // ì˜¤ëŠ˜ ë‚ ì§œ yyyy-MM-dd ë¬¸ìì—´ ìƒì„±
        const d = new Date();
        const yyyy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
        const dateStr = `${yyyy}-${mm}-${dd}`;
        try{
            // ì„œë²„ì— ì˜¤ëŠ˜ ìš”ì•½ API ìš”ì²­
            const res = await fetch(`/api/reports/summary?date=${dateStr}`, { headers: {'X-ANON-ID': anonId} });
            if(res.ok){
                const json = await res.json();
                // totalSec ë˜ëŠ” totalSeconds ê°’ìœ¼ë¡œ ì˜¤ëŠ˜ í•©ê³„ í‘œì‹œ
                todayTotal.textContent = fmtSec((json.totalSec ?? json.totalSeconds) || 0);
            } else {
                // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ í‘œì‹œ
                todayTotal.textContent = '--:--:--';
            }
        }catch(_){
            // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ê°’ í‘œì‹œ
            todayTotal.textContent = '--:--:--';
        }
    }

    // ì´ë²ˆ ì£¼ ëˆ„ì  ì§‘ì¤‘ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    async function fetchThisWeekTotal(){
        try{
            const res = await fetch(`/api/reports/weekly?weeks=1`, { headers: {'X-ANON-ID': anonId} });
            const arr = res.ok ? await res.json() : [];
            // ì²« ì£¼ì°¨ ë°ì´í„°ì˜ totalSeconds ê°€ì ¸ì˜¤ê¸°
            const sec = Array.isArray(arr) && arr.length ? (arr[0].totalSeconds || 0) : 0;
            thisWeekTotal.textContent = fmtSec(sec);
        }catch(_){
            thisWeekTotal.textContent='--:--:--';
        }
    }

    // ì´ë²ˆ ë‹¬ ëˆ„ì  ì§‘ì¤‘ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    async function fetchThisMonthTotal(){
        try{
            const res = await fetch(`/api/reports/monthly?months=1`, { headers: {'X-ANON-ID': anonId} });
            const arr = res.ok ? await res.json() : [];
            // ì²« ë‹¬ ë°ì´í„°ì˜ totalSeconds ê°€ì ¸ì˜¤ê¸°
            const sec = Array.isArray(arr) && arr.length ? (arr[0].totalSeconds || 0) : 0;
            thisMonthTotal.textContent = fmtSec(sec);
        }catch(_){
            thisMonthTotal.textContent='--:--:--';
        }
    }

    /* ========= ëª©í‘œ ì§„í–‰ë¥  ========= */
    // ëª©í‘œ ë³´ê¸° ê¸°ê°„(daily/weekly/monthly) ë³€ê²½ ì´ë²¤íŠ¸
    goalViewPeriod.addEventListener('change', ()=> fetchGoalProgress(goalViewPeriod.value));

    // ëª©í‘œ ì§„í–‰ë¥  API í˜¸ì¶œ ë° UI ì—…ë°ì´íŠ¸
    async function fetchGoalProgress(period){
        try{
            // ì„œë²„ì— ëª©í‘œ ì§„í–‰ë¥  ìš”ì²­
            const res = await fetch(`/api/goals/progress?period=${period}`, { headers: {'X-ANON-ID': anonId} });
            if(!res.ok){ setGoalUnset(); return; }
            const j = await res.json();
            if (!j || j.targetSeconds == null){ setGoalUnset(); return; }

            // ì§„í–‰ë¥  ê³„ì‚° (progress ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ achieved/target ê³„ì‚°)
            const base = (j.progress ?? (j.achievedSeconds/j.targetSeconds)) || 0;
            const pct = Math.min(100, Math.round(base*100));

            // UI ì—…ë°ì´íŠ¸
            goalPct.textContent = `${pct}%`;
            goalBar.style.width = `${pct}%`;
            goalDesc.textContent = `${periodLabel(period)} ${fmtSec(j.achievedSeconds||0)} / ëª©í‘œ ${fmtSec(j.targetSeconds||0)}`;
        }catch(_){
            setGoalUnset();
        }
    }

    // ëª©í‘œ ë¯¸ì„¤ì • ìƒíƒœ UI ì²˜ë¦¬
    function setGoalUnset(){
        goalPct.textContent = 'ë¯¸ì„¤ì •';
        goalBar.style.width = '0%';
        goalDesc.textContent = 'ëª©í‘œë¥¼ ì„¤ì •í•´ ë³´ì„¸ìš”.';
    }

    // ê¸°ê°„ ë¼ë²¨ ë³€í™˜ í•¨ìˆ˜
    function periodLabel(p){
        return p==='weekly'?'ì´ë²ˆ ì£¼':(p==='monthly'?'ì´ë²ˆ ë‹¬':'ì˜¤ëŠ˜');
    }

    /* ========= ëª©í‘œ ì„¤ì • ëª¨ë‹¬ ========= */
    // ëª©í‘œ ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
    btnOpenGoal.addEventListener('click', () => {
        goalPeriod.value = 'DAILY';
        goalHours.value = '';
        goalMinutes.value = '';
        goalFrom.value = '';
        goalModal.classList.add('show-flex'); // ëª¨ë‹¬ ë³´ì´ê¸°
        goalModal.setAttribute('aria-hidden','false');
        setTimeout(()=>goalHours.focus(), 0); // ì…ë ¥ì°½ì— ìë™ í¬ì»¤ìŠ¤
    });

    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
    btnCloseGoal.addEventListener('click', closeGoalModal);

    // ëª¨ë‹¬ì—ì„œ ESC â†’ ë‹«ê¸° / Enter â†’ ì €ì¥ ë™ì‘
    goalModal.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape') { e.preventDefault(); closeGoalModal(); }
        if (e.key === 'Enter')  { e.preventDefault(); btnSaveGoal.click(); }
    });

    // ëª©í‘œ ì €ì¥ ë²„íŠ¼ ë™ì‘
    btnSaveGoal.addEventListener('click', async () => {
        try{
            // ì…ë ¥ê°’(ì‹œê°„/ë¶„)ì„ ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜
            const hours = parseInt(goalHours.value || '0', 10);
            const mins  = parseInt(goalMinutes.value || '0', 10);
            const seconds = Math.max(0, hours*3600 + mins*60);
            if (!seconds){ showToast('ëª©í‘œ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.', true); return; }

            // API ìš”ì²­ ë°”ë”” ìƒì„±
            const body = {
                periodType: goalPeriod.value,
                targetSeconds: seconds,
                effectiveFrom: goalFrom.value || undefined
            };

            // ì„œë²„ì— ëª©í‘œ ì €ì¥ ìš”ì²­
            const res = await fetch('/api/goals', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-ANON-ID': anonId },
                body: JSON.stringify(body)
            });
            if(!res.ok){
                const t = await res.text().catch(()=> '');
                throw new Error(t || 'ëª©í‘œ ì €ì¥ ì‹¤íŒ¨');
            }

            // ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸
            closeGoalModal();
            showToast('ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            await fetchGoalProgress(goalViewPeriod.value || 'daily');
        }catch(e){
            showToast(e.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', true);
        }
    });

    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    function closeGoalModal(){
        goalModal.classList.remove('show-flex');
        goalModal.setAttribute('aria-hidden','true');
    }

    /* ========= ë­í‚¹ ========= */
    async function fetchRanking(period, targetBody){
        try {
            const res = await fetch(`/api/rankings/${period}`, {
                headers: { 'X-ANON-ID': anonId }
            });
            const arr = res.ok ? await res.json() : [];
            renderRanking(arr, targetBody);
        } catch(e) {
            console.error("ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
            targetBody.innerHTML = `<tr><td colspan="3" class="muted">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</td></tr>`;
        }
    }

    function renderRanking(arr, targetBody){
        targetBody.innerHTML = "";
        if (!arr || !arr.length){
            targetBody.innerHTML = `<tr><td colspan="3" class="muted">ë°ì´í„° ì—†ìŒ</td></tr>`;
            return;
        }
        arr.forEach((r,i)=>{
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${i+1}</td>
                <td>${r.displayName || r.anonId || 'ìµëª…'}</td>
                <td>${secToHMS(r.seconds || 0)}</td>
            `;
            targetBody.appendChild(tr);
        });
    }

    /* ========= ë”ë¸”í´ë¦­ ë°©ì§€ ========= */
    let inFlight = new Set(); // ì‹¤í–‰ ì¤‘ì¸ ì‘ì—… ì €ì¥
    async function safeCall(key, fn){
        if (inFlight.has(key)) return; // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ë¬´ì‹œ
        inFlight.add(key);
        try{
            await fn();
        } finally {
            inFlight.delete(key); // ì‹¤í–‰ ëë‚˜ë©´ ì œê±°
        }
    }
    // ì…ê¸ˆ/ì •ì‚° ë²„íŠ¼ í´ë¦­ ì‹œ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    btnDeposit.addEventListener('click', ()=> safeCall('deposit', onDeposit));
    btnSettle .addEventListener('click', ()=> safeCall('settle',  onSettle));

    /* ========= ì„¸ì…˜ ë¡œì»¬ ì €ì¥ ========= */
    // localStorage í‚¤ ì´ë¦„ ì •ì˜
    const LS_KEYS = { activeSession: 'fb.activeSession', sessionLog: 'fb.sessionLog' };

    // í˜„ì¬ ì„¸ì…˜ ìƒíƒœ ì €ì¥
    function persistActiveSession() {
        if (currentSessionId && startedAtMs)
            localStorage.setItem(LS_KEYS.activeSession, JSON.stringify({ sessionId: currentSessionId, startedAtMs }));
        else
            localStorage.removeItem(LS_KEYS.activeSession);
    }

    // ì„¸ì…˜ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadSessionLog(){
        try{ return JSON.parse(localStorage.getItem(LS_KEYS.sessionLog) || '{}'); }
        catch(_){ return {}; }
    }

    // ì„¸ì…˜ ê¸°ë¡ ì €ì¥
    function saveSessionLog(map){ localStorage.setItem(LS_KEYS.sessionLog, JSON.stringify(map)); }

    // timestamp â†’ yyyy-MM-dd ë³€í™˜
    function dayKeyFromMs(ms){
        const d = new Date(typeof ms === 'number' ? ms : Date.now());
        const yyyy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
    }

    // ì„¸ì…˜ ì‹œì‘ ê¸°ë¡ ì €ì¥
    function logStart(sessionId, startedAtMs){
        const map = loadSessionLog();
        const key = dayKeyFromMs(startedAtMs);
        map[key] = map[key] || [];
        if(!map[key].some(s => s.sessionId === sessionId)){
            map[key].push({
                sessionId,
                startedAt: toLocalDateTimeString(new Date(startedAtMs)),
                endedAt: null
            });
            saveSessionLog(map);
        }
    }

    // ì„¸ì…˜ ì¢…ë£Œ ê¸°ë¡ ì €ì¥
    function logEnd(sessionId, endedAtMs){
        const map = loadSessionLog();
        Object.keys(map).forEach(k=>{
            const s = map[k]?.find(x => x.sessionId === sessionId);
            if (s && !s.endedAt) {
                s.endedAt = toLocalDateTimeString(new Date(endedAtMs));
            }
        });
        saveSessionLog(map);
    }

    // íŠ¹ì • ë‚ ì§œì˜ ì„¸ì…˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    function getLocalSessionsFor(dateStr){
        const map = loadSessionLog();
        return Array.isArray(map[dateStr]) ? map[dateStr] : [];
    }

    /* ========= ì„¸ì…˜ë³„ ë§‰ëŒ€ ========= */
    // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ yyyy-MM-dd ë¬¸ìì—´ë¡œ ë³€í™˜
    function todayStr(){
        const d = new Date();
        const yyyy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
    }

    // ë¶„ ë‹¨ìœ„ ê°’ì„ ì‚¬ëŒì´ ì½ê¸° ì¢‹ì€ ë¬¸ìì—´(ì‹œê°„/ë¶„)ë¡œ ë³€í™˜
    function fmtMinK(m){
        if (m < 60) return `${m}ë¶„`; // 1ì‹œê°„ ë¯¸ë§Œì´ë©´ ê·¸ëƒ¥ ë¶„ ë‹¨ìœ„
        const h = Math.floor(m/60), mm = m % 60;
        return mm ? `${h}ì‹œê°„ ${mm}ë¶„` : `${h}ì‹œê°„`; // 1ì‹œê°„ ì´ìƒì´ë©´ ì‹œê°„+ë¶„
    }

    // LocalDateTime â†’ Date ë³€í™˜ (ë¬¸ìì—´/Date/number ëª¨ë‘ ì²˜ë¦¬, í•­ìƒ ë¡œì»¬ KST ê¸°ì¤€)
    function parseLocalDateTime(v){
        if (!v) return null;

        // ì´ë¯¸ Date ê°ì²´ì¸ ê²½ìš°
        if (v instanceof Date) return v;

        // ìˆ«ì(ms íƒ€ì„ìŠ¤íƒ¬í”„)ì¸ ê²½ìš°
        if (typeof v === 'number') return new Date(v);

        // ë¬¸ìì—´ì¸ ê²½ìš°
        if (typeof v === 'string'){
            // ISO 8601 + íƒ€ì„ì¡´(Z, +09:00 ë“±)ì´ ë¶™ì€ ê²½ìš°
            if (/Z|[+\-]\d{2}:?\d{2}$/.test(v)) {
                const d = new Date(v);
                return isNaN(+d) ? null : d;
            }

            // ì„œë²„ LocalDateTime í˜•ì‹: yyyy-MM-ddTHH:mm:ss(.SSS)
            const [date, time='00:00:00'] = v.split('T');
            if (!date) return null;

            const [y,m,d] = date.split('-').map(Number);
            const [hh='0', mm='0', ss='0'] = time.split('.')[0].split(':');

            const dObj = new Date(y, (m||1)-1, d||1, Number(hh), Number(mm), Number(ss));
            return isNaN(+dObj) ? null : dObj;
        }

        return null;
    }

    function toLocalDateTimeString(d){
        const yyyy = d.getFullYear();
        const mm   = String(d.getMonth()+1).padStart(2,'0');
        const dd   = String(d.getDate()).padStart(2,'0');
        const hh   = String(d.getHours()).padStart(2,'0');
        const mi   = String(d.getMinutes()).padStart(2,'0');
        const ss   = String(d.getSeconds()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}:${ss}`;
    }

    // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì„œë²„/ë¡œì»¬ ì„¸ì…˜ ëª©ë¡ í•©ì¹˜ê¸°
    async function fetchTodaySessions(){
        const date = todayStr(); // ì˜¤ëŠ˜ yyyy-MM-dd
        const localArr = getLocalSessionsFor(date);
        let serverArr = [];
        try {
            const res = await fetch(`/api/sessions?date=${date}`, {
                headers: { 'X-ANON-ID': anonId }
            });
            if (res.ok) serverArr = await res.json();
        } catch(_) {}

        const byId = new Map();

        const upsert = (s)=>{
            if (!s || !s.sessionId || !s.startedAt) return;
            const prev = byId.get(s.sessionId);

            const sStart = parseLocalDateTime(s.startedAt);
            const pStart = prev?.startedAt ? parseLocalDateTime(prev.startedAt) : null;
            const startedAt = (!pStart || (sStart && sStart < pStart)) ? sStart : pStart;

            const sEnd = s.endedAt ? parseLocalDateTime(s.endedAt) : null;
            const pEnd = prev?.endedAt ? parseLocalDateTime(prev.endedAt) : null;
            let endedAt = null;
            if (sEnd && !pEnd) endedAt = sEnd;
            else if (!sEnd && pEnd) endedAt = pEnd;
            else if (sEnd && pEnd) endedAt = (sEnd > pEnd ? sEnd : pEnd);

            // Date ê°ì²´ë¡œ ì €ì¥
            byId.set(s.sessionId, { ...prev, ...s, startedAt, endedAt });
        };

        localArr.forEach(upsert);
        serverArr.forEach(upsert);

        // í˜„ì¬ ì§„í–‰ ì¤‘ ì„¸ì…˜ì€ ê°•ì œë¡œ ë°˜ì˜
        if (currentSessionId && startedAtMs){
            const prev = byId.get(currentSessionId) || {};
            byId.set(currentSessionId, {
                ...prev,
                sessionId: currentSessionId,
                startedAt: new Date(startedAtMs),
                endedAt: null
            });
        }

        function localYMD(d){
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        return [...byId.values()].filter(s=>{
            const start = parseLocalDateTime(s.startedAt);
            return start && localYMD(start) === todayStr(); // todayStr()ì€ ë¡œì»¬ yyyy-MM-dd
        });
    }

    // ì„¸ì…˜ë³„ ë§‰ëŒ€ ì°¨íŠ¸ ì „ì—­ ë³€ìˆ˜
    let sessionBarChart;

    // ì„¸ì…˜ë³„ ë§‰ëŒ€ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
    async function renderSessionBars(){
        if (!sessionBarCanvas) return; // ìº”ë²„ìŠ¤ ì—†ìœ¼ë©´ ì¢…ë£Œ
        const sessions = await fetchTodaySessions(); // ì˜¤ëŠ˜ ì„¸ì…˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°

        // ì‹œì‘ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ëª¨ë‘ Date ê°ì²´ë¡œ ë³€í™˜ í›„ ë¹„êµ)
        const sorted = sessions
            .filter(s => s.startedAt)
            .sort((a,b)=> parseLocalDateTime(a.startedAt) - parseLocalDateTime(b.startedAt));

        // ì„¸ì…˜ì´ ì—†ìœ¼ë©´ "ì•„ì§ ì—†ìŒ" ë©”ì‹œì§€ í‘œì‹œ
        if (!sorted.length){
            sessionBarEmpty.style.display = 'block';
            return;
        }
        sessionBarEmpty.style.display = 'none';

        // ê° ì„¸ì…˜ì˜ ë¼ë²¨: "níšŒ Â· hh:mm"
        const labels = sorted.map((s,i)=>{
            const d = parseLocalDateTime(s.startedAt);
            if (!d || isNaN(d)) return `${i+1}íšŒ`; // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì˜ˆì™¸ ì²˜ë¦¬
            const hh = String(d.getHours()).padStart(2,'0');
            const mm = String(d.getMinutes()).padStart(2,'0');
            return `${i+1}íšŒ Â· ${hh}:${mm}`;
        });

        // ê° ì„¸ì…˜ì˜ ê¸¸ì´(ë¶„) ê³„ì‚°
        const dataMin = sorted.map((s)=>{
            const start = parseLocalDateTime(s.startedAt);
            let end = s.endedAt
                ? parseLocalDateTime(s.endedAt)
                : (s.sessionId === currentSessionId ? new Date() : start);

            if (!start || !end || isNaN(start) || isNaN(end)) return 0;
            return Math.max(0, Math.round((end - start)/60000));
        });

        // Chart.js ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
        if (!window.__chartLoaded){
            await loadChartJs();
            window.__chartLoaded = true;
        }
        if (sessionBarChart) sessionBarChart.destroy(); // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
        const ctx = sessionBarCanvas.getContext('2d');
        sessionBarChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'ì„¸ì…˜ ê¸¸ì´(ë¶„)', data: dataMin }] },
            options: {
                responsive:true,
                maintainAspectRatio:false,
                scales:{
                    y:{
                        beginAtZero:true,
                        ticks:{ callback:(v)=> formatMinutesTick(v) }
                    }
                },
                plugins:{
                    tooltip:{
                        callbacks:{
                            label:(c)=> formatMinutesTick(c.parsed.y)
                        }
                    }
                }
            }
        });
        sessionBarCanvas.parentElement.style.height = '280px';
    }

    // ì§„í–‰ ì¤‘ì¼ ë•Œ 1ë¶„ë§ˆë‹¤ ë§‰ëŒ€ ê°±ì‹ 
    let liveUiTick;
    function startLiveUiTick(){
        if (liveUiTick) clearInterval(liveUiTick); // ê¸°ì¡´ íƒ€ì´ë¨¸ ì œê±°
        liveUiTick = setInterval(async ()=>{
            if (currentSessionId){
                await renderSessionBars(); // 1ë¶„ë§ˆë‹¤ ê·¸ë˜í”„ ë‹¤ì‹œ ê·¸ë¦¼
            }
        }, 60000);
    }
    function stopLiveUiTick(){ if (liveUiTick) clearInterval(liveUiTick); }

    /* ========= ìœ í‹¸ ========= */
    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ (ì§§ê²Œ íŒì—…)
    function showToast(msg, error=false){
        toastEl.textContent = msg;
        toastEl.style.borderColor = error ? 'rgba(239,68,68,.5)' : 'rgba(56,189,248,.5)';
        toastEl.classList.add('show');
        setTimeout(()=>toastEl.classList.remove('show'), 2200);
    }

    // Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë™ì  ë¡œë”© (CDNì—ì„œ import)
    async function loadChartJs(){
        await import('https://cdn.jsdelivr.net/npm/chart.js');
    }

    // ìµëª… ID ë§ˆìŠ¤í‚¹ (ë’¤ 4ìë¦¬ë§Œ í‘œì‹œ)
    function maskAnon(id){
        if(!id) return 'anon-****';
        const tail=id.slice(-4).toUpperCase();
        return 'anon-'+tail;
    }

    // ì´ˆ â†’ HH:mm:ss í˜•ì‹ ë³€í™˜
    function fmtSec(s){
        const h=String(Math.floor(s/3600)).padStart(2,'0');
        const m=String(Math.floor((s%3600)/60)).padStart(2,'0');
        const sec=String(Math.floor(s%60)).padStart(2,'0');
        return `${h}:${m}:${sec}`;
    }

    // ì´ˆ â†’ "hì‹œê°„ më¶„" í˜•ì‹ ë³€í™˜
    function secToHMS(sec){
        const h=Math.floor(sec/3600);
        const m=Math.floor((sec%3600)/60);
        return `${h}ì‹œê°„ ${m}ë¶„`;
    }

    // ê°„ë‹¨ ULID ìƒì„±ê¸° (ëœë¤ + ì‹œê°„ ì¡°í•©)
    function generateULID(){
        const ENCODING = "0123456789ABCDEFGHJKMNPQRSTVWXYZ";
        function rand(n){
            const bytes=new Uint8Array(n);
            (crypto.getRandomValues||window.msCrypto.getRandomValues).call(crypto,bytes);
            return Array.from(bytes);
        }
        const time = Date.now(); let t=time; const timeChars=[];
        // ì‹œê°„ ê¸°ë°˜ 10ìë¦¬
        for(let i=0;i<10;i++){ timeChars.push(ENCODING[t%32]); t=Math.floor(t/32); }
        // ëœë¤ 16ìë¦¬
        const randomBytes = rand(16); const randChars=[]; let bits=0,val=0;
        for (let i=0;i<randomBytes.length;i++){
            val=(val<<8)|randomBytes[i];
            bits+=8;
            while(bits>=5){
                bits-=5;
                randChars.push(ENCODING[(val>>>bits)&31]);
            }
        }
        while(randChars.length<16) randChars.push('0');
        return timeChars.reverse().join('') + randChars.slice(0,16).join('');
    }

    /* ========= ë‹‰ë„¤ì„ ì„¤ì • ========= */ // ë‹‰ë„¤ì„ ê´€ë ¨ UIì™€ API ì—°ë™ ë¡œì§

    // ë‹‰ë„¤ì„ ëª¨ë‹¬ ì—´ê¸°
    btnOpenNickname.addEventListener('click', ()=>{
        nicknameModal.classList.add('show-flex'); // ëª¨ë‹¬ ë°±ë“œë¡­ì— í‘œì‹œìš© í´ë˜ìŠ¤ ì¶”ê°€(ë³´ì´ê²Œ í•¨)
        nicknameModal.setAttribute('aria-hidden','false'); // ì ‘ê·¼ì„± ì†ì„±: ëª¨ë‹¬ì´ ì—´ë ¸ìŒì„ ìŠ¤í¬ë¦°ë¦¬ë”ì— ì•Œë¦¼
        nickInput.value = '';
        nickCheckMsg.textContent = '';
        setTimeout(()=>nickInput.focus(),0); // ë‹¤ìŒ í‹±ì—ì„œ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤ ì´ë™(ëª¨ë‹¬ ì—´ë¦¼ í›„ í¬ì»¤ìŠ¤ ë³´ì¥)
    });

    // ëª¨ë‹¬ ë‹«ê¸° // ë‹«ê¸° ë²„íŠ¼ê³¼ í•¨ìˆ˜ ì •ì˜ ì„¹ì…˜ ì†Œê°œ
    btnCloseNickname.addEventListener('click', closeNicknameModal);
    function closeNicknameModal(){
        nicknameModal.classList.remove('show-flex'); // í‘œì‹œìš© í´ë˜ìŠ¤ ì œê±°(ìˆ¨ê¹€)
        nicknameModal.setAttribute('aria-hidden','true'); // ì ‘ê·¼ì„± ì†ì„±: ëª¨ë‹¬ì´ ë‹«í˜”ìŒì„ ì•Œë¦¼
    }

    // ESC / Enter ë‹¨ì¶•í‚¤ // í‚¤ë³´ë“œë¡œ ëª¨ë‹¬ ì œì–´
    nicknameModal.addEventListener('keydown',(e)=>{ // ëª¨ë‹¬ ë‚´ë¶€ì—ì„œ í‚¤ë‹¤ìš´ ì´ë²¤íŠ¸ ê°ì§€
        if(e.key==='Escape'){ e.preventDefault(); closeNicknameModal(); } // ESC í‚¤ë©´ ê¸°ë³¸ë™ì‘ ë§‰ê³  ëª¨ë‹¬ ë‹«ê¸°
        if(e.key==='Enter'){ e.preventDefault(); btnSaveNick.click(); } // Enter í‚¤ë©´ ê¸°ë³¸ë™ì‘ ë§‰ê³  ì €ì¥ ë²„íŠ¼ í´ë¦­ íŠ¸ë¦¬ê±°
    });

    // ë‹‰ë„¤ì„ ì €ì¥
    btnSaveNick.addEventListener('click', async ()=>{
        const val = nickInput.value.trim();

        // ì…ë ¥ê°’ì´ ë¹„ì–´ ìˆìœ¼ë©´ ê²½ê³  í›„ ì¤‘ë‹¨
        if(!val){
            showToast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.', true);
            return;
        }

        try{
            // ì„œë²„ì— ë‹‰ë„¤ì„ ì €ì¥ ìš”ì²­ (POST)
            const res = await fetch('/api/profile/nickname', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-ANON-ID': anonId
                },
                body: JSON.stringify({ nickname: val })
            });
            if(!res.ok) throw new Error(await res.text());

            // ì„±ê³µ ì‹œ ì‘ë‹µ JSON íŒŒì‹± (ë‹‰ë„¤ì„ + íƒœê·¸)
            const j = await res.json();

            // ë‹‰ë„¤ì„ ì—…ë°ì´íŠ¸
            displayNameEl.textContent = `${j.nickname}#${j.nicknameTag}`;
            displayNameEl.classList.add('display-pill');

            // ë‹‰ë„¤ì„ì´ ìˆìœ¼ë©´ ì‹ë³„ì ìˆ¨ê¹€
            document.getElementById('anonRow').style.display = 'none';

            closeNicknameModal();
            showToast('ë‹‰ë„¤ì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }catch(e){
            showToast('ë‹‰ë„¤ì„ ì €ì¥ ì‹¤íŒ¨: ' + (e.message || e), true);
        }
    });

    async function fetchProfile(){
        try{
            const res=await fetch('/api/profile',{headers:{'X-ANON-ID':anonId}});
            if(res.ok){
                const j=await res.json();
                if(j.nickname && j.nicknameTag){
                    // ë‹‰ë„¤ì„ í‘œì‹œ
                    displayNameEl.textContent = `${j.nickname}#${j.nicknameTag}`;
                    displayNameEl.classList.add('display-pill');
                    // ì‹ë³„ì ìˆ¨ê¹€
                    document.getElementById('anonRow').style.display = 'none';
                } else {
                    // ë‹‰ë„¤ì„ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ + ì‹ë³„ì í‘œì‹œ
                    displayNameEl.textContent = 'ë‹‰ë„¤ì„ ë¯¸ì„¤ì •';
                    displayNameEl.classList.remove('display-pill');
                    document.getElementById('anonRow').style.display = '';
                }
            }
        }catch(_){ }
    }

    /* ========= ì„œë²„ì™€ ë¡œì»¬ ì„¸ì…˜ ë™ê¸°í™” ========= */
    async function syncActiveSession(){
        // 1) ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ê°’ ìš°ì„  ì ìš© (ì„ì‹œ ìƒíƒœ)
        const saved = localStorage.getItem(LS_KEYS.activeSession);
        if (saved) {
            try {
                const { sessionId, startedAtMs: s } = JSON.parse(saved);
                if (sessionId && s) {
                    currentSessionId = sessionId;
                    startedAtMs = s;
                    setStatusRunning();
                    startTick();
                }
            } catch(_) { /* íŒŒì‹± ì‹¤íŒ¨ â†’ ë¬´ì‹œ */ }
        }

        // 2) ì„œë²„ ìƒíƒœë¡œ ìµœì¢… ë™ê¸°í™” (ì„œë²„ë¥¼ ì§„ì‹¤ë¡œ ê°„ì£¼)
        try {
            const res = await fetch('/api/sessions/active', {
                headers: { 'X-ANON-ID': anonId }
            });
            if (res.status === 200){
                const j = await res.json();
                currentSessionId = j.sessionId;
                startedAtMs = parseLocalDateTime(j.startedAt).getTime();
                setStatusRunning();
                startTick();
            } else {
                // ì„œë²„ì—ì„œ active ì—†ìŒ â†’ ë¡œì»¬ ê¸°ë¡ë„ ì§€ì›Œì•¼ í•¨
                setStatusIdle();
            }
        } catch(e){
            console.error("ì§„í–‰ ì¤‘ ì„¸ì…˜ ë³µì› ì‹¤íŒ¨:", e);
        }
    }

    /* ========= ì´ˆê¸°í™” ========= */
    (function init(){
        // ì„œë²„ì™€ ë¡œì»¬ ì„¸ì…˜ ìƒíƒœ ë™ê¸°í™”
        syncActiveSession();

        // ë‹‰ë„¤ì„ í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° í˜¸ì¶œ
        fetchProfile();

        // ìš”ì•½/í•©ê³„/ëª©í‘œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        fetchTodaySummary();
        fetchThisWeekTotal();
        fetchThisMonthTotal();
        fetchGoalProgress(goalViewPeriod.value || 'daily');

        // ì²« í™”ë©´ì—ì„œ ì„¸ì…˜ë³„ ë§‰ëŒ€ ê·¸ë˜í”„ ë Œë”ë§
        renderSessionBars();

        // ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸°
        fetchRanking('weekly', weeklyRankingBody);
        fetchRanking('overall', overallRankingBody);
    })();
</script>
</body>
</html>
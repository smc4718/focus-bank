<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Focus Bank - ë””ì§€í„¸ ì§‘ì¤‘ë ¥ ì€í–‰</title>
    <style>
        :root { --bg:#0f172a; --card:#111827; --muted:#9ca3af; --txt:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --brand:#38bdf8; }
        *{box-sizing:border-box}
        body{margin:0;font-family:ui-sans-serif,system-ui,AppleSDGothicNeo,'Noto Sans KR',Segoe UI,Roboto,Arial;background:linear-gradient(120deg,#0b1220,#10192b)}
        .wrap{max-width:960px;margin:0 auto;padding:28px}
        .app-title{display:flex;align-items:center;gap:12px;color:#fff}
        .logo{font-size:28px}
        .subtitle{color:var(--muted);margin-top:4px}

        /* ì¹´ë“œ/ê·¸ë¦¬ë“œ */
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px}
        .card{background:rgba(17,24,39,.8);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:18px;color:var(--txt);box-shadow:0 10px 30px rgba(0,0,0,.25)}
        .section-title{margin:0 0 10px 0;color:#fff;font-weight:700;font-size:18px}
        .row{display:flex;justify-content:space-between;align-items:center;margin:10px 0}
        .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:8px 12px;background:rgba(255,255,255,.06);color:#fff}
        .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
        .btns{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
        button{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:700;color:#0b1020;transition:.2s}
        .btn-deposit{background:var(--accent)}
        .btn-settle{background:var(--danger)}
        .btn-deposit:disabled,.btn-settle:disabled{opacity:.5;cursor:not-allowed}
        .balance{font-size:28px;font-weight:800;color:#fff}
        .muted{color:var(--muted);font-size:13px}
        .toast{position:fixed;right:20px;bottom:20px;background:#111827;color:#fff;border:1px solid rgba(255,255,255,.12);padding:12px 16px;border-radius:12px;opacity:0;transform:translateY(10px);transition:.2s}
        .toast.show{opacity:1;transform:none}
        .hero{margin-top:18px;display:flex;gap:10px;align-items:center;color:#cbd5e1}
        .hero b{color:#fff}
        .timer{font-variant-numeric:tabular-nums}
        .footer{margin-top:18px;color:#6b7280;font-size:12px}
        @media (max-width:800px){.grid{grid-template-columns:1fr}}

        /* íƒ­ */
        .tabs{display:flex;gap:8px;margin-top:14px}
        .tab{border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:8px 12px;background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
        .tab.active{background:#fff;color:#0b1220}

        /* ëª©í‘œ ì§„í–‰ë¥  */
        .progress{height:12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);overflow:hidden}
        .progress .bar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#38bdf8)}

        /* ëª¨ë‹¬ */
        .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px}
        .modal{background:rgba(17,24,39,.98);border:1px solid rgba(255,255,255,.08);border-radius:16px;max-width:420px;width:100%;padding:18px;color:#fff}
        .modal h3{margin:0 0 12px 0}
        .modal .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
        .modal input,.modal select{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);color:#e5e7eb}
        .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:6px}
        .btn-ghost{background:rgba(255,255,255,.12);color:#fff}
        .btn-brand{background:var(--brand);color:#0b1020}
        .show-flex{display:flex}

        /* ìŠ¤ì¼ˆë ˆí†¤ */
        .skeleton{background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(255,255,255,.12),rgba(255,255,255,.06)); background-size:200% 100%; animation:s 1.2s linear infinite;}
        @keyframes s {0%{background-position:0 0}100%{background-position:-200% 0}}
    </style>
</head>
<body>
<div class="wrap">
    <div class="app-title">
        <div class="logo">ğŸ¦</div>
        <div>
            <h1 style="margin:0;color:#fff;">Focus Bank</h1>
            <div class="subtitle">ì§‘ì¤‘ ì‹œê°„ì„ ëˆì²˜ëŸ¼ <b>ì…ê¸ˆ/ì •ì‚°</b>í•˜ì„¸ìš”</div>
        </div>
    </div>

    <!-- íƒ­ -->
    <div class="tabs">
        <div id="tab-dashboard" class="tab">ëŒ€ì‹œë³´ë“œ</div>
        <div id="tab-reports" class="tab">ë¦¬í¬íŠ¸</div>
    </div>

    <!-- [ë·°1] ëŒ€ì‹œë³´ë“œ -->
    <section id="view-dashboard">
        <div class="grid">
            <div class="card">
                <h2 class="section-title">ë‚´ ì •ë³´</h2>
                <div class="row"><div>ì‹ë³„ì</div><div id="anonDisplay" class="pill mono">anon-????</div></div>
                <div class="row"><div>í˜„ì¬ ìƒíƒœ</div><div id="statusPill" class="pill">ëŒ€ê¸° ì¤‘</div></div>
                <div class="row"><div>ì§„í–‰ íƒ€ì´ë¨¸</div><div id="liveTimer" class="mono timer">00:00:00</div></div>
                <div class="btns">
                    <button id="btnDeposit" class="btn-deposit">ì…ê¸ˆí•˜ê¸°</button>
                    <button id="btnSettle" class="btn-settle" disabled>ì •ì‚°í•˜ê¸°</button>
                    <button class="pill" id="btnGoReports">ë¦¬í¬íŠ¸ ë³´ê¸°</button>
                </div>
                <div class="hero">ğŸ’¡ <span>ì…ê¸ˆì€ ì§‘ì¤‘ ì‹œì‘, ì •ì‚°ì€ ì¢…ë£Œë¥¼ ì˜ë¯¸í•´ìš”.</span></div>
            </div>

            <div class="card">
                <h2 class="section-title">ì¼ì¼ ì…ê¸ˆëœ ì§‘ì¤‘</h2>
                <div class="balance" id="todayTotal">--:--:--</div>
                <div class="muted">ì˜¤ëŠ˜ ëˆ„ì  ì§‘ì¤‘ ì‹œê°„</div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2 class="section-title">ì´ë²ˆ ì£¼ í•©ê³„</h2>
                <div class="balance" id="thisWeekTotal">--:--:--</div>
                <div class="muted">ì›”ìš”ì¼~ì˜¤ëŠ˜ ê¸°ì¤€(ISO ì£¼)</div>
            </div>

            <div class="card">
                <h2 class="section-title">ì´ë²ˆ ë‹¬ í•©ê³„</h2>
                <div class="balance" id="thisMonthTotal">--:--:--</div>
                <div class="muted">1ì¼~ì˜¤ëŠ˜ ê¸°ì¤€</div>
            </div>

            <div class="card" style="grid-column: 1 / -1">
                <div style="display:flex;align-items:center;gap:8px;">
                    <h2 class="section-title" style="margin:0;">ëª©í‘œ ì§„í–‰ë¥ </h2>
                    <select id="goalViewPeriod" class="pill" style="margin-left:auto">
                        <option value="daily" selected>ì¼ê°„</option>
                        <option value="weekly">ì£¼ê°„</option>
                        <option value="monthly">ì›”ê°„</option>
                    </select>
                    <button id="btnOpenGoal" class="btn-ghost">ëª©í‘œ ì„¤ì •</button>
                </div>
                <div class="row">
                    <div class="muted">ë‹¬ì„±ë¥ </div>
                    <div id="goalPct" class="pill">ë¯¸ì„¤ì •</div>
                </div>
                <div class="progress"><div id="goalBar" class="bar"></div></div>
                <div class="muted" id="goalDesc" style="margin-top:8px;">ëª©í‘œë¥¼ ì„¤ì •í•´ ë³´ì„¸ìš”.</div>
            </div>

            <!-- ì„¸ì…˜ë³„ ë§‰ëŒ€ (ì˜¤ëŠ˜) -->
            <div class="card" style="grid-column: 1 / -1">
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <h2 class="section-title" style="margin:0;">ì„¸ì…˜ë³„ ë§‰ëŒ€ (ì˜¤ëŠ˜)</h2>
                    <div class="muted" id="sessionBarHint">ê° ì„¸ì…˜ ê¸¸ì´(ë¶„)</div>
                </div>
                <div style="border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:12px; position:relative;">
                    <canvas id="sessionBarCanvas"></canvas>
                    <div id="sessionBarEmpty" class="muted" style="display:none;margin-top:6px;">ì˜¤ëŠ˜ ì„¸ì…˜ì´ ì•„ì§ ì—†ì–´ìš”.</div>
                </div>
            </div>
        </div>
    </section>

    <!-- [ë·°2] ë¦¬í¬íŠ¸ -->
    <section id="view-reports" hidden>
        <div class="grid">
            <div class="card" style="grid-column:1 / -1">
                <h2 class="section-title" style="display:flex;align-items:center;gap:8px;">
                    ì£¼ê°„/ì›”ê°„ ì§‘ì¤‘ ë¦¬í¬íŠ¸
                    <span class="muted" style="margin-left:auto;">í‘œì‹œ ë‹¨ìœ„</span>
                    <select id="chartUnit" class="pill">
                        <option value="auto" selected>ìë™</option>
                        <option value="minutes">ë¶„</option>
                        <option value="hours">ì‹œê°„(ì†Œìˆ˜)</option>
                    </select>
                </h2>
                <div class="btns" style="margin-bottom:8px;">
                    <button class="pill" id="btnWeekly" data-mode="weekly">ì£¼ê°„</button>
                    <button class="pill" id="btnMonthly" data-mode="monthly">ì›”ê°„</button>
                </div>
                <div style="border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:12px; position:relative;">
                    <canvas id="reportChart"></canvas>
                    <div id="reportError" class="muted" style="display:none;margin-top:8px;"></div>
                    <div class="muted" id="rangeLabel" style="margin-top:6px;"></div>
                </div>
                <div class="grid" style="margin-top:16px;">
                    <div class="card">
                        <div>ì´ ì§‘ì¤‘ì‹œê°„</div>
                        <div class="balance" id="kpiTotal">--:--:--</div>
                        <div class="muted">ì„ íƒëœ ê¸°ê°„ í•©ê³„</div>
                    </div>
                    <div class="card">
                        <div>ì¼ë‹¹ í‰ê· </div>
                        <div class="balance" id="kpiAvg">0ì´ˆ</div>
                        <div class="muted">í•´ë‹¹ ê¸°ê°„ ì¼í‰ê· </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="footer">Â© Focus Bank Â· ë‹¨ì¼ í˜ì´ì§€ ëŒ€ì‹œë³´ë“œ (Thymeleaf + JS)</div>
</div>

<!-- ëª©í‘œ ì„¤ì • ëª¨ë‹¬ -->
<div id="goalModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="goalTitle">
        <h3 id="goalTitle">ëª©í‘œ ì„¤ì •</h3>
        <div class="field">
            <label for="goalPeriod">ê¸°ê°„</label>
            <select id="goalPeriod">
                <option value="DAILY">ì¼ê°„</option>
                <option value="WEEKLY">ì£¼ê°„</option>
                <option value="MONTHLY">ì›”ê°„</option>
            </select>
        </div>
        <div class="field">
            <label for="goalHours">ëª©í‘œ ì‹œê°„</label>
            <div style="display:flex;gap:8px;">
                <input id="goalHours" type="number" min="0" placeholder="ì‹œê°„(h)" style="flex:1;">
                <input id="goalMinutes" type="number" min="0" max="59" placeholder="ë¶„(m)" style="flex:1;">
            </div>
            <small class="muted">ì˜ˆ: 2ì‹œê°„ 30ë¶„ â†’ 2ì™€ 30 ì…ë ¥</small>
        </div>
        <div class="field">
            <label for="goalFrom">ì‹œì‘ì¼(ì„ íƒ)</label>
            <input id="goalFrom" type="date" />
            <small class="muted">ë¹„ìš°ë©´ ì˜¤ëŠ˜ë¶€í„° ì ìš©</small>
        </div>
        <div class="actions">
            <button id="btnCloseGoal" class="btn-ghost">ì·¨ì†Œ</button>
            <button id="btnSaveGoal" class="btn-brand">ì €ì¥</button>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    /* ========= ìµëª… ID ========= */
    (function ensureAnon() {
        let anonId = localStorage.getItem('anonId');
        if (!anonId) {
            anonId = generateULID();
            localStorage.setItem('anonId', anonId);
        }
    })();
    const anonId = localStorage.getItem('anonId');

    /* ========= DOM ========= */
    const anonDisplay = document.getElementById('anonDisplay');
    const statusPill  = document.getElementById('statusPill');
    const liveTimerEl = document.getElementById('liveTimer');
    const btnDeposit  = document.getElementById('btnDeposit');
    const btnSettle   = document.getElementById('btnSettle');
    const toastEl     = document.getElementById('toast');
    const todayTotal  = document.getElementById('todayTotal');

    const thisWeekTotal  = document.getElementById('thisWeekTotal');
    const thisMonthTotal = document.getElementById('thisMonthTotal');
    const goalPct        = document.getElementById('goalPct');
    const goalBar        = document.getElementById('goalBar');
    const goalDesc       = document.getElementById('goalDesc');

    const tabDashboard = document.getElementById('tab-dashboard');
    const tabReports   = document.getElementById('tab-reports');
    const btnGoReports = document.getElementById('btnGoReports');
    const btnWeekly    = document.getElementById('btnWeekly');
    const btnMonthly   = document.getElementById('btnMonthly');
    const reportCanvas = document.getElementById('reportChart');
    const kpiTotal     = document.getElementById('kpiTotal');
    const kpiAvg       = document.getElementById('kpiAvg');
    const rangeLabel   = document.getElementById('rangeLabel');
    const reportError  = document.getElementById('reportError');
    const chartUnitSel = document.getElementById('chartUnit');

    const goalModal   = document.getElementById('goalModal');
    const btnOpenGoal = document.getElementById('btnOpenGoal');
    const btnCloseGoal= document.getElementById('btnCloseGoal');
    const btnSaveGoal = document.getElementById('btnSaveGoal');
    const goalPeriod  = document.getElementById('goalPeriod');
    const goalHours   = document.getElementById('goalHours');
    const goalMinutes = document.getElementById('goalMinutes');
    const goalFrom    = document.getElementById('goalFrom');
    const goalViewPeriod = document.getElementById('goalViewPeriod');

    // ì„¸ì…˜ ë§‰ëŒ€ DOM
    const sessionBarCanvas = document.getElementById('sessionBarCanvas');
    const sessionBarEmpty  = document.getElementById('sessionBarEmpty');

    anonDisplay.textContent = maskAnon(anonId);

    /* ========= ë¼ìš°íŒ… ========= */
    btnGoReports.addEventListener('click', () => navigate('#/reports'));
    const routes = {
        '#/dashboard': () => { setActiveTab('dashboard'); showView('view-dashboard'); },
        '#/reports': async () => {
            setActiveTab('reports'); showView('view-reports');
            if (!window.__chartLoaded) { await loadChartJs(); window.__chartLoaded = true; }
            if (!window.__reportMode) window.__reportMode = 'weekly';
            if (!window.__chartUnit)  window.__chartUnit  = chartUnitSel.value || 'auto';
            await renderReport(window.__reportMode);
        }
    };
    function navigate(hash){ if (location.hash === hash) routes[hash]?.(); else location.hash = hash; }
    function setActiveTab(name){
        tabDashboard.classList.toggle('active', name === 'dashboard');
        tabReports.classList.toggle('active', name === 'reports');
    }
    function showView(id){
        document.getElementById('view-dashboard').hidden = id !== 'view-dashboard';
        document.getElementById('view-reports').hidden   = id !== 'view-reports';
    }
    function router(){ const hash = location.hash || '#/dashboard'; (routes[hash] || routes['#/dashboard'])(); }
    window.addEventListener('hashchange', router);
    window.addEventListener('load', router);
    tabDashboard.addEventListener('click', () => navigate('#/dashboard'));
    tabReports  .addEventListener('click', () => navigate('#/reports'));

    /* ========= ë¦¬í¬íŠ¸/ì°¨íŠ¸ ========= */
    async function loadChartJs(){ await import('https://cdn.jsdelivr.net/npm/chart.js'); }
    btnWeekly.addEventListener('click', () => { window.__reportMode = 'weekly'; renderReport('weekly'); });
    btnMonthly.addEventListener('click', () => { window.__reportMode = 'monthly'; renderReport('monthly'); });
    chartUnitSel?.addEventListener('change', () => { window.__chartUnit = chartUnitSel.value; renderReport(window.__reportMode); });

    let reportChart;
    async function renderReport(mode){
        const box = reportCanvas.parentElement;
        const placeholder = document.createElement('div');
        placeholder.className='skeleton'; placeholder.style.height='360px'; placeholder.style.borderRadius='12px';
        box.insertBefore(placeholder, reportCanvas);

        try{
            const url = mode === 'weekly'
                ? `/api/reports/weekly?weeks=12`
                : `/api/reports/monthly?months=12`;
            const res = await fetch(url, { headers: { 'X-ANON-ID': anonId } });
            if (!res.ok) throw new Error('ë¦¬í¬íŠ¸ ë¡œë”© ì‹¤íŒ¨');
            const data = await res.json();

            const labels  = data.map(d => d.period);
            const totalsS = data.map(d => (d.totalSeconds || 0));

            const userUnit = window.__chartUnit || 'auto';
            const maxMinutes = Math.max(0, ...totalsS.map(s => Math.round(s/60)));
            let unit = userUnit;
            if (userUnit === 'auto') {
                unit = (mode === 'weekly') ? (maxMinutes < 120 ? 'minutes' : 'hours') : 'hours';
            }
            window.__effectiveUnit = unit;

            const series = unit === 'minutes'
                ? totalsS.map(s => Math.round(s/60))
                : totalsS.map(s => Number((s/3600).toFixed(1)));

            const totalSec = totalsS.reduce((a,b)=> a + b, 0);
            const avgSec   = data.length ? Math.round(data.reduce((a,b)=> a + (b.avgSecPerDay || 0), 0) / data.length) : 0;
            kpiTotal.textContent = secToHMS(totalSec);
            kpiAvg.textContent   = (avgSec < 3600) ? `${Math.round(avgSec/60)}ë¶„` : `${(avgSec/3600).toFixed(1)}ì‹œê°„`;
            rangeLabel.textContent = mode === 'weekly' ? 'ìµœê·¼ 12ì£¼' : 'ìµœê·¼ 12ê°œì›”';

            if (reportChart) reportChart.destroy();
            const ctx = reportCanvas.getContext('2d');
            reportChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: mode === 'weekly'
                            ? (unit==='minutes' ? 'ì£¼ê°„ ì´ ì§‘ì¤‘(ë¶„)' : 'ì£¼ê°„ ì´ ì§‘ì¤‘(ì‹œê°„)')
                            : (unit==='minutes' ? 'ì›”ê°„ ì´ ì§‘ì¤‘(ë¶„)' : 'ì›”ê°„ ì´ ì§‘ì¤‘(ì‹œê°„)'),
                        data: series
                    }]
                },
                options: {
                    responsive:true,
                    maintainAspectRatio:false,
                    scales:{
                        y:{
                            beginAtZero:true,
                            ticks:{ callback:(v)=> unit==='minutes' ? formatMinutesTick(v) : `${v}h` }
                        }
                    },
                    plugins:{
                        tooltip:{
                            callbacks:{
                                label:(ctx)=> {
                                    const v = ctx.parsed.y;
                                    if (unit === 'minutes') return formatMinutesTick(v);
                                    const totalMin = Math.round((Number(v)||0) * 60);
                                    return formatMinutesTick(totalMin);
                                }
                            }
                        }
                    }
                }
            });
            reportCanvas.parentElement.style.height = '360px';
            reportError.style.display = 'none';
        } catch(e){
            reportError.style.display = 'block';
            reportError.innerHTML = `ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. <button class="pill" onclick="renderReport('${mode}')">ì¬ì‹œë„</button>`;
        } finally {
            placeholder.remove();
        }
    }

    function formatMinutesTick(v){
        const m = Math.round(Number(v)||0);
        if (m < 60) return `${m}ë¶„`;
        const h = Math.floor(m/60), mm = m%60;
        return mm === 0 ? `${h}ì‹œê°„` : `${h}ì‹œê°„ ${mm}ë¶„`;
    }

    /* ========= ì…ê¸ˆ/ì •ì‚° ========= */
    let currentSessionId = null, tickTimer = null, startedAtMs = null;

    async function onDeposit() {
        try {
            btnDeposit.disabled = true;
            const res = await fetch('/api/sessions/deposit', { method: 'POST', headers: { 'X-ANON-ID': anonId } });
            if (res.status === 409){ showToast('ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ì„¸ì…˜ì´ ìˆìŠµë‹ˆë‹¤.', true); btnDeposit.disabled = false; return; }
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            currentSessionId = data.sessionId;
            startedAtMs = Date.parse(data.startedAt ?? data.createdAt);
            setStatusRunning(); startTick(); showToast('ì…ê¸ˆì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨');

            logStart(currentSessionId, startedAtMs);
            await renderSessionBars();
        } catch (e) { showToast('ì…ê¸ˆ ì‹¤íŒ¨: ' + (e.message || e), true); btnDeposit.disabled = false; }
    }
    async function onSettle() {
        if (!currentSessionId){ showToast('ì§„í–‰ ì¤‘ì¸ ì…ê¸ˆ(ì§‘ì¤‘)ì´ ì—†ìŠµë‹ˆë‹¤.', true); return; }
        try {
            btnSettle.disabled = true;
            const res = await fetch(`/api/sessions/settle?sessionId=${currentSessionId}`, { method: 'POST' });
            if (res.status === 409){ showToast('ì´ë¯¸ ì¢…ë£Œëœ ì„¸ì…˜ì…ë‹ˆë‹¤.', true); btnSettle.disabled = false; return; }
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json(); // {durationSec,...}
            stopTick(); setStatusIdle();
            await fetchTodaySummary();
            await fetchThisWeekTotal();
            await fetchThisMonthTotal();
            await fetchGoalProgress(goalViewPeriod.value || 'daily');
            showToast(`ì •ì‚° ì™„ë£Œ! ì´ë²ˆ ì…ê¸ˆ: ${fmtSec(data.durationSec || 0)} â±ï¸`);

            logEnd(currentSessionId, Date.now());
            await renderSessionBars();
        } catch (e) { showToast('ì •ì‚° ì‹¤íŒ¨: ' + (e.message || e), true); btnSettle.disabled = false; }
    }
    function setStatusRunning(){
        statusPill.textContent='ì…ê¸ˆ ì¤‘';
        statusPill.style.background='rgba(34,197,94,.15)';
        statusPill.style.borderColor='rgba(34,197,94,.35)';
        btnSettle.disabled=false; btnDeposit.disabled=true;
        persistActiveSession();
    }
    function setStatusIdle(){
        statusPill.textContent='ëŒ€ê¸° ì¤‘';
        statusPill.style.background='rgba(255,255,255,.06)';
        statusPill.style.borderColor='rgba(255,255,255,.12)';
        btnSettle.disabled=true; btnDeposit.disabled=false;
        liveTimerEl.textContent='00:00:00'; currentSessionId=null; startedAtMs=null;
        persistActiveSession();
    }
    function startTick(){
        if (!startedAtMs) startedAtMs=Date.now();
        liveTimerEl.textContent=fmtSec(Math.floor((Date.now()-startedAtMs)/1000));
        tickTimer=setInterval(()=>{
            const sec=Math.floor((Date.now()-startedAtMs)/1000);
            liveTimerEl.textContent=fmtSec(sec);
        },1000);
        startLiveUiTick(); // ì§„í–‰ ì¤‘ì¼ ë•Œ ë§‰ëŒ€ 1ë¶„ ê°±ì‹ 
        persistActiveSession();
    }
    function stopTick(){
        if (tickTimer) clearInterval(tickTimer);
        stopLiveUiTick();
        persistActiveSession();
    }

    /* ========= ì˜¤ëŠ˜ ìš”ì•½ í˜¸ì¶œ ========= */
    async function fetchTodaySummary(){
        const d = new Date();
        const yyyy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
        const dateStr = `${yyyy}-${mm}-${dd}`;
        try{
            const res = await fetch(`/api/reports/summary?date=${dateStr}`, { headers: {'X-ANON-ID': anonId} });
            if(res.ok){
                const json = await res.json();
                todayTotal.textContent = fmtSec((json.totalSec ?? json.totalSeconds) || 0);
            } else { todayTotal.textContent = '--:--:--'; }
        }catch(_){ todayTotal.textContent = '--:--:--'; }
    }
    async function fetchThisWeekTotal(){
        try{
            const res = await fetch(`/api/reports/weekly?weeks=1`, { headers: {'X-ANON-ID': anonId} });
            const arr = res.ok ? await res.json() : [];
            const sec = Array.isArray(arr) && arr.length ? (arr[0].totalSeconds || 0) : 0;
            thisWeekTotal.textContent = fmtSec(sec);
        }catch(_){ thisWeekTotal.textContent='--:--:--'; }
    }
    async function fetchThisMonthTotal(){
        try{
            const res = await fetch(`/api/reports/monthly?months=1`, { headers: {'X-ANON-ID': anonId} });
            const arr = res.ok ? await res.json() : [];
            const sec = Array.isArray(arr) && arr.length ? (arr[0].totalSeconds || 0) : 0;
            thisMonthTotal.textContent = fmtSec(sec);
        }catch(_){ thisMonthTotal.textContent='--:--:--'; }
    }

    /* ========= ëª©í‘œ ì§„í–‰ë¥  ========= */
    goalViewPeriod.addEventListener('change', ()=> fetchGoalProgress(goalViewPeriod.value));
    async function fetchGoalProgress(period){
        try{
            const res = await fetch(`/api/goals/progress?period=${period}`, { headers: {'X-ANON-ID': anonId} });
            if(!res.ok){ setGoalUnset(); return; }
            const j = await res.json();
            if (!j || j.targetSeconds == null){ setGoalUnset(); return; }
            const base = (j.progress ?? (j.achievedSeconds/j.targetSeconds)) || 0;
            const pct = Math.min(100, Math.round(base*100));
            goalPct.textContent = `${pct}%`;
            goalBar.style.width = `${pct}%`;
            goalDesc.textContent = `${periodLabel(period)} ${fmtSec(j.achievedSeconds||0)} / ëª©í‘œ ${fmtSec(j.targetSeconds||0)}`;
        }catch(_){ setGoalUnset(); }
    }
    function setGoalUnset(){
        goalPct.textContent = 'ë¯¸ì„¤ì •';
        goalBar.style.width = '0%';
        goalDesc.textContent = 'ëª©í‘œë¥¼ ì„¤ì •í•´ ë³´ì„¸ìš”.';
    }
    function periodLabel(p){ return p==='weekly'?'ì´ë²ˆ ì£¼':(p==='monthly'?'ì´ë²ˆ ë‹¬':'ì˜¤ëŠ˜'); }

    /* ========= ëª©í‘œ ì„¤ì • ëª¨ë‹¬ ========= */
    btnOpenGoal.addEventListener('click', () => {
        goalPeriod.value = 'DAILY';
        goalHours.value = '';
        goalMinutes.value = '';
        goalFrom.value = '';
        goalModal.classList.add('show-flex');
        goalModal.setAttribute('aria-hidden','false');
        setTimeout(()=>goalHours.focus(), 0);
    });
    btnCloseGoal.addEventListener('click', closeGoalModal);
    goalModal.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape') { e.preventDefault(); closeGoalModal(); }
        if (e.key === 'Enter')  { e.preventDefault(); btnSaveGoal.click(); }
    });
    goalModal.addEventListener('keydown', (e)=>{
        if (e.key !== 'Tab') return;
        const focusables = goalModal.querySelectorAll('button,select,input');
        if (!focusables.length) return;
        const first = focusables[0], last = focusables[focusables.length-1];
        if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    });
    btnSaveGoal.addEventListener('click', async () => {
        try{
            const hours = parseInt(goalHours.value || '0', 10);
            const mins  = parseInt(goalMinutes.value || '0', 10);
            const seconds = Math.max(0, hours*3600 + mins*60);
            if (!seconds){ showToast('ëª©í‘œ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.', true); return; }
            const body = { periodType: goalPeriod.value, targetSeconds: seconds, effectiveFrom: goalFrom.value || undefined };
            const res = await fetch('/api/goals', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'X-ANON-ID': anonId }, body: JSON.stringify(body)
            });
            if(!res.ok){ const t = await res.text().catch(()=> ''); throw new Error(t || 'ëª©í‘œ ì €ì¥ ì‹¤íŒ¨'); }
            closeGoalModal(); showToast('ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. âœ…');
            await fetchGoalProgress(goalViewPeriod.value || 'daily');
        }catch(e){ showToast(e.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', true); }
    });
    function closeGoalModal(){ goalModal.classList.remove('show-flex'); goalModal.setAttribute('aria-hidden','true'); }

    /* ========= ë”ë¸”í´ë¦­ ë°©ì§€ ========= */
    let inFlight = new Set();
    async function safeCall(key, fn){ if (inFlight.has(key)) return; inFlight.add(key); try{ await fn(); } finally { inFlight.delete(key); } }
    btnDeposit.addEventListener('click', ()=> safeCall('deposit', onDeposit));
    btnSettle .addEventListener('click', ()=> safeCall('settle',  onSettle));

    /* ========= ì„¸ì…˜ ë¡œì»¬ ì €ì¥ ========= */
    const LS_KEYS = { activeSession: 'fb.activeSession', sessionLog: 'fb.sessionLog' };
    function persistActiveSession() {
        if (currentSessionId && startedAtMs) localStorage.setItem(LS_KEYS.activeSession, JSON.stringify({ sessionId: currentSessionId, startedAtMs }));
        else localStorage.removeItem(LS_KEYS.activeSession);
    }
    function loadSessionLog(){
        try{ return JSON.parse(localStorage.getItem(LS_KEYS.sessionLog) || '{}'); }
        catch(_){ return {}; }
    }
    function saveSessionLog(map){ localStorage.setItem(LS_KEYS.sessionLog, JSON.stringify(map)); }
    function dayKeyFromMs(ms){
        const d = new Date(typeof ms === 'number' ? ms : Date.now());
        const yyyy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
    }
    function logStart(sessionId, startedAtMs){
        const map = loadSessionLog();
        const key = dayKeyFromMs(startedAtMs);
        map[key] = map[key] || [];
        if(!map[key].some(s => s.sessionId === sessionId)){
            map[key].push({ sessionId, startedAt: new Date(startedAtMs).toISOString(), endedAt: null });
            saveSessionLog(map);
        }
    }
    function logEnd(sessionId, endedAtMs){
        const map = loadSessionLog();
        Object.keys(map).forEach(k=>{
            const s = map[k]?.find(x => x.sessionId === sessionId);
            if (s) s.endedAt = new Date(endedAtMs).toISOString();
        });
        saveSessionLog(map);
    }
    function getLocalSessionsFor(dateStr){
        const map = loadSessionLog();
        return Array.isArray(map[dateStr]) ? map[dateStr] : [];
    }

    /* ========= ì„¸ì…˜ë³„ ë§‰ëŒ€ ========= */
    function todayStr(){
        const d = new Date();
        const yyyy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
    }
    async function fetchTodaySessions(){
        const date = todayStr();
        const localArr = getLocalSessionsFor(date);
        let serverArr = [];
        try {
            const res = await fetch(`/api/sessions?date=${date}`, { headers: { 'X-ANON-ID': anonId } });
            if (res.ok) serverArr = await res.json();
        } catch(_) {}
        // sessionId ë³‘í•© (ì„œë²„ ìš°ì„ )
        const map = new Map();
        [...localArr, ...serverArr].forEach(s => {
            if (!s || !s.sessionId) return;
            const prev = map.get(s.sessionId) || {};
            map.set(s.sessionId, { ...prev, ...s });
        });
        // ì§„í–‰ ì¤‘ ì„¸ì…˜ ë³´ì •
        if (currentSessionId && startedAtMs){
            const prev = map.get(currentSessionId) || {};
            map.set(currentSessionId, { ...prev, sessionId: currentSessionId, startedAt: new Date(startedAtMs).toISOString(), endedAt: null });
        }
        // startedAt ì—†ëŠ” ì˜ëª»ëœ í•­ëª© ì œê±°
        return Array.from(map.values()).filter(s=>s.startedAt);
    }

    // âœ… ëˆ„ì ê°’ìœ¼ë¡œ ë‚´ë ¤ì™€ë„ â€œê° íšŒì°¨ ê³ ìœ  ì‹œê°„(Î”)â€ìœ¼ë¡œ ìë™ ë³´ì •
    function computePerSessionMinutes(sortedSessions){
        const n = sortedSessions.length;
        if (!n) return [];
        const startMs = sortedSessions.map(s => new Date(s.startedAt).getTime());
        const endMs   = sortedSessions.map(s => (s.endedAt ? new Date(s.endedAt) : new Date()).getTime());

        // (1) ì¼ë°˜ ì¼€ì´ìŠ¤: ê° ì„¸ì…˜ì˜ ì‹œì‘~ì¢…ë£Œ ì°¨ì´
        let per = startMs.map((st,i)=> Math.max(0, Math.round((endMs[i]-st)/60000)));

        // (2) ì„œë²„ê°€ ëª¨ë‘ ê°™ì€ ì‹œì‘ì‹œê°(ë˜ëŠ” ê±°ì˜ ë™ì¼)ìœ¼ë¡œ ëˆ„ì ê°’ì„ ì¤€ ê²½ìš° â†’ ì¢…ë£Œì‹œê° ì°¨ë¶„ìœ¼ë¡œ ë³´ì •
        const first = startMs[0];
        const sameStartCount = startMs.filter(ms => Math.abs(ms-first) < 60*1000).length; // 1ë¶„ ì´ë‚´ ë™ì¼ íŒë‹¨
        const majoritySameStart = sameStartCount >= Math.max(2, Math.ceil(n*0.8));

        if (majoritySameStart){
            per[0] = Math.max(0, Math.round((endMs[0] - startMs[0]) / 60000));
            for (let i=1;i<n;i++){
                per[i] = Math.max(0, Math.round((endMs[i] - endMs[i-1]) / 60000));
            }
            return per;
        }

        // (3) ì¶”ê°€ ì•ˆì „ì¥ì¹˜: perê°€ ë¹„ì •ìƒì ìœ¼ë¡œ ë‹¨ì¡°ì¦ê°€(ëˆ„ì ìŠ¤ë©œ)ì´ê³ , ì¢…ë£Œì‹œê°ì´ ë‹¨ì¡°ì¦ê°€ & ì‹œì‘ì‹œê°ë“¤ì´ ê±°ì˜ ë™ì¼í•˜ë©´ ì°¨ë¶„ ë³´ì •
        const nonDec = per.every((v,i,a)=> i===0 || v>=a[i-1]);
        const endNonDec = endMs.every((v,i,a)=> i===0 || v>=a[i-1]);
        const startsNearFirst = startMs.every(ms => Math.abs(ms-first) < 5*60*1000);
        if (nonDec && endNonDec && startsNearFirst && n>=3){
            const diff = new Array(n).fill(0);
            diff[0] = per[0];
            for (let i=1;i<n;i++) diff[i] = Math.max(0, per[i] - per[i-1]);
            return diff;
        }
        return per;
    }

    let sessionBarChart;
    async function renderSessionBars(){
        const container = document.getElementById('sessionBars');
        const summaryEl = document.getElementById('sessionBarsSummary');
        if (!container) return;

        container.innerHTML = ''; // ì´ˆê¸°í™”

        const date = todayStr();
        const sessions = await fetchTodaySessions();
        if (!sessions.length) {
            summaryEl.textContent = 'ì„¸ì…˜ ì—†ìŒ';
            return;
        }

        let totalMinutes = 0;

        sessions
            .filter(s => s.startedAt)
            .sort((a,b)=> new Date(a.startedAt) - new Date(b.startedAt))
            .forEach((s, idx) => {
                // === í•µì‹¬ ìˆ˜ì • ë¶€ë¶„ ===
                let durMin = 0;
                if (s.endedAt) {
                    // ì¢…ë£Œëœ ì„¸ì…˜ â†’ ê³ ì • ê¸¸ì´
                    durMin = Math.max(0, Math.round((new Date(s.endedAt) - new Date(s.startedAt)) / 60000));
                } else {
                    // ì§„í–‰ ì¤‘ ì„¸ì…˜ë§Œ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ê³„ì‚°
                    durMin = Math.max(0, Math.round((Date.now() - new Date(s.startedAt)) / 60000));
                }
                // =====================

                totalMinutes += durMin;

                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.width = durMin + 'px'; // ë‹¨ìˆœíˆ pxë¡œ ê°€ë¡œ ê¸¸ì´ í‘œí˜„ (ì›í•˜ëŠ” ë¹„ìœ¨ ì¡°ì • ê°€ëŠ¥)
                bar.textContent = `${idx+1}íšŒì°¨ Â· ${fmtMinK(durMin)}`;

                container.appendChild(bar);
            });

        summaryEl.textContent = `ì„¸ì…˜ ${sessions.length}ê°œ Â· ì´ ${fmtMinK(totalMinutes)}`;
    }

    // ì§„í–‰ ì¤‘ì¼ ë•Œ 1ë¶„ë§ˆë‹¤ ë§‰ëŒ€ ê°±ì‹ 
    let liveUiTick;
    function startLiveUiTick(){
        if (liveUiTick) clearInterval(liveUiTick);
        liveUiTick = setInterval(async ()=>{
            if (currentSessionId){
                await renderSessionBars();
            }
        }, 60000);
    }
    function stopLiveUiTick(){ if (liveUiTick) clearInterval(liveUiTick); }

    /* ========= ìœ í‹¸ ========= */
    function showToast(msg, error=false){
        toastEl.textContent = msg;
        toastEl.style.borderColor = error ? 'rgba(239,68,68,.5)' : 'rgba(56,189,248,.5)';
        toastEl.classList.add('show');
        setTimeout(()=>toastEl.classList.remove('show'), 2200);
    }
    function maskAnon(id){ if(!id) return 'anon-****'; const tail=id.slice(-4).toUpperCase(); return 'anon-'+tail; }
    function fmtSec(s){ const h=String(Math.floor(s/3600)).padStart(2,'0'); const m=String(Math.floor((s%3600)/60)).padStart(2,'0'); const sec=String(Math.floor(s%60)).padStart(2,'0'); return `${h}:${m}:${sec}`; }
    function secToHMS(sec){ const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); return `${h}ì‹œê°„ ${m}ë¶„`; }

    // ê°„ë‹¨ ULID (ì˜¤íƒ€ ìˆ˜ì • ë²„ì „)
    function generateULID(){
        const ENCODING = "0123456789ABCDEFGHJKMNPQRSTVWXYZ";
        function rand(n){
            const bytes=new Uint8Array(n);
            (crypto.getRandomValues||window.msCrypto.getRandomValues).call(crypto,bytes);
            return Array.from(bytes);
        }
        const time = Date.now(); let t=time; const timeChars=[];
        for(let i=0;i<10;i++){ timeChars.push(ENCODING[t%32]); t=Math.floor(t/32); }
        const randomBytes = rand(16); const randChars=[]; let bits=0,val=0;
        for (let i=0;i<randomBytes.length;i++){
            val=(val<<8)|randomBytes[i];
            bits+=8;
            while(bits>=5){
                bits-=5;
                randChars.push(ENCODING[(val>>>bits)&31]);
            }
        }
        while(randChars.length<16) randChars.push('0');
        return timeChars.reverse().join('') + randChars.slice(0,16).join('');
    }

    /* ========= ì´ˆê¸°í™” ========= */
    (function init(){
        const saved = localStorage.getItem(LS_KEYS.activeSession);
        if (saved) {
            try {
                const { sessionId, startedAtMs: s } = JSON.parse(saved);
                if (sessionId && s) { currentSessionId = sessionId; startedAtMs = s; setStatusRunning(); startTick(); }
            } catch(_) { /* ignore */ }
        }
        window.__chartUnit = (typeof chartUnitSel !== 'undefined' && chartUnitSel) ? chartUnitSel.value : 'auto';
        fetchTodaySummary();
        fetchThisWeekTotal();
        fetchThisMonthTotal();
        fetchGoalProgress(goalViewPeriod.value || 'daily');

        // ì²« ë Œë”: ì„¸ì…˜ ë§‰ëŒ€
        renderSessionBars();
    })();
</script>
</body>
</html>